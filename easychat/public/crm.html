<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EasyChat CRM | ××¢×¨×›×ª × ×™×”×•×œ ×œ×™×“×™×</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800&family=Rubik:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    <style>
        :root { --primary: #06D6A0; --primary-dark: #05B888; --secondary: #118AB2; --bg: #F8FAFB; --text: #073B4C; --text-light: #6B7280; --navy: #073B4C; --border: #E5E7EB; --success: #10B981; --warning: #F59E0B; --danger: #EF4444; --purple: #8B5CF6; --shadow-sm: 0 1px 2px rgba(0,0,0,0.05); --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1); --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1); --shadow-xl: 0 20px 25px -5px rgba(0,0,0,0.1); --radius-sm: 6px; --radius-md: 10px; --radius-lg: 16px; --radius-xl: 24px; --font-display: 'Rubik', sans-serif; --font-body: 'Heebo', sans-serif; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-body); background: var(--bg); color: var(--text); min-height: 100vh; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        .app-container { display: flex; min-height: 100vh; }
        .sidebar { width: 280px; background: var(--navy); color: white; padding: 24px 16px; display: flex; flex-direction: column; position: fixed; height: 100vh; z-index: 100; overflow-y: auto; }
        .sidebar-logo { font-family: var(--font-display); font-size: 28px; font-weight: 700; color: var(--primary); margin-bottom: 8px; }
        .sidebar-subtitle { font-size: 12px; color: rgba(255,255,255,0.5); margin-bottom: 32px; }
        .sidebar-nav { flex: 1; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: var(--radius-md); color: rgba(255,255,255,0.7); cursor: pointer; transition: all 0.2s; margin-bottom: 4px; font-size: 15px; }
        .nav-item:hover { background: rgba(255,255,255,0.1); color: white; }
        .nav-item.active { background: var(--primary); color: white; }
        .nav-item-icon { font-size: 20px; width: 24px; text-align: center; }
        .nav-badge { margin-right: auto; background: var(--danger); color: white; font-size: 11px; padding: 2px 8px; border-radius: 10px; font-weight: 600; }
        .nav-submenu { margin-right: 20px; margin-top: 4px; margin-bottom: 8px; overflow: hidden; transition: max-height 0.3s ease; max-height: 500px; }
        .nav-submenu.collapsed { max-height: 0; margin: 0; }
        .nav-submenu-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; border-radius: var(--radius-sm); color: rgba(255,255,255,0.6); cursor: pointer; transition: all 0.2s; font-size: 13px; margin-bottom: 2px; }
        .nav-submenu-item:hover { background: rgba(255,255,255,0.1); color: white; }
        .nav-submenu-item.active { background: rgba(6,214,160,0.2); color: var(--primary); }
        .nav-submenu-item .count { background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; }
        .nav-item-expandable { display: flex; align-items: center; justify-content: space-between; width: 100%; }
        .expand-icon { transition: transform 0.3s; font-size: 12px; }
        .expand-icon.expanded { transform: rotate(180deg); }
        .sidebar-user { padding: 16px; border-top: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 12px; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center; font-weight: 600; }
        .user-info { flex: 1; }
        .user-name { font-weight: 600; font-size: 14px; }
        .user-role { font-size: 12px; color: rgba(255,255,255,0.5); }
        .main-content { flex: 1; margin-right: 280px; padding: 24px 32px; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .page-title { font-family: var(--font-display); font-size: 28px; font-weight: 700; }
        .header-actions { display: flex; gap: 12px; }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 10px 20px; font-family: var(--font-body); font-size: 14px; font-weight: 500; border: none; border-radius: var(--radius-md); cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); box-shadow: var(--shadow-md); }
        .btn-secondary { background: white; color: var(--text); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--bg); border-color: var(--text-light); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #DC2626; }
        .btn-sm { padding: 6px 12px; font-size: 13px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: white; border-radius: var(--radius-lg); padding: 20px; box-shadow: var(--shadow-sm); border: 1px solid var(--border); transition: all 0.2s; }
        .stat-card:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); }
        .stat-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .stat-card-icon { width: 44px; height: 44px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 22px; }
        .stat-card-icon.blue { background: rgba(17,138,178,0.1); }
        .stat-card-icon.green { background: rgba(6,214,160,0.1); }
        .stat-card-icon.yellow { background: rgba(245,158,11,0.1); }
        .stat-card-icon.purple { background: rgba(139,92,246,0.1); }
        .stat-card-value { font-family: var(--font-display); font-size: 32px; font-weight: 700; color: var(--text); }
        .stat-card-label { font-size: 14px; color: var(--text-light); }
        .filters-bar { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
        .search-input { flex: 1; min-width: 200px; padding: 10px 16px; padding-right: 40px; border: 1px solid var(--border); border-radius: var(--radius-md); font-family: var(--font-body); font-size: 14px; background: white; }
        .search-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(6,214,160,0.1); }
        .filter-select { padding: 10px 16px; border: 1px solid var(--border); border-radius: var(--radius-md); font-family: var(--font-body); font-size: 14px; background: white; cursor: pointer; min-width: 150px; }
        .filter-select:focus { outline: none; border-color: var(--primary); }
        .table-container { background: white; border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); border: 1px solid var(--border); overflow: hidden; }
        .table { width: 100%; border-collapse: collapse; }
        .table th { background: var(--bg); padding: 14px 16px; text-align: right; font-weight: 600; font-size: 13px; color: var(--text-light); border-bottom: 1px solid var(--border); white-space: nowrap; }
        .table td { padding: 16px; border-bottom: 1px solid var(--border); font-size: 14px; }
        .table tr:last-child td { border-bottom: none; }
        .table tr:hover { background: var(--bg); cursor: pointer; }
        .lead-score { display: flex; align-items: center; gap: 4px; font-size: 12px; }
        .lead-score.hot { color: #EF4444; }
        .lead-score.warm { color: #F59E0B; }
        .lead-score.cold { color: #6B7280; }
        .status-badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; }
        .status-badge.new { background: rgba(139,92,246,0.1); color: #7C3AED; }
        .status-badge.followup_initial { background: rgba(245,158,11,0.1); color: #D97706; }
        .status-badge.followup_qualified { background: rgba(17,138,178,0.1); color: #0E7490; }
        .status-badge.interested { background: rgba(6,214,160,0.1); color: #059669; }
        .status-badge.demo { background: rgba(59,130,246,0.1); color: #2563EB; }
        .status-badge.closed_won { background: rgba(16,185,129,0.1); color: #059669; }
        .status-badge.not_interested { background: rgba(239,68,68,0.1); color: #DC2626; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; }
        .source-badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 500; }
        .source-badge.facebook { background: rgba(24,119,242,0.1); color: #1877F2; }
        .source-badge.instagram { background: rgba(225,48,108,0.1); color: #E1306C; }
        .source-badge.google { background: rgba(66,133,244,0.1); color: #4285F4; }
        .source-badge.website { background: rgba(6,214,160,0.1); color: #059669; }
        .source-badge.referral { background: rgba(139,92,246,0.1); color: #7C3AED; }
        .source-badge.organic { background: rgba(107,114,128,0.1); color: #6B7280; }
        .lead-panel { position: fixed; top: 0; left: 0; width: 520px; height: 100vh; background: white; box-shadow: var(--shadow-xl); z-index: 200; display: flex; flex-direction: column; transform: translateX(-100%); transition: transform 0.3s ease; }
        .lead-panel.open { transform: translateX(0); }
        .panel-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.3); z-index: 199; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .panel-overlay.open { opacity: 1; visibility: visible; }
        .panel-header { padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .panel-title { font-family: var(--font-display); font-size: 20px; font-weight: 600; }
        .panel-close { width: 32px; height: 32px; border-radius: var(--radius-sm); border: none; background: var(--bg); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; transition: all 0.2s; }
        .panel-close:hover { background: var(--border); }
        .panel-tabs { display: flex; border-bottom: 1px solid var(--border); padding: 0 24px; }
        .panel-tab { padding: 12px 16px; font-size: 14px; font-weight: 500; color: var(--text-light); cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; }
        .panel-tab:hover { color: var(--text); }
        .panel-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        .panel-content { flex: 1; overflow-y: auto; padding: 24px; }
        .panel-section { margin-bottom: 28px; }
        .panel-section-title { font-size: 12px; font-weight: 600; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; }
        .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
        .info-item { background: var(--bg); padding: 12px; border-radius: var(--radius-md); }
        .info-label { font-size: 11px; color: var(--text-light); margin-bottom: 4px; }
        .info-value { font-weight: 500; font-size: 14px; }
        .notes-list { display: flex; flex-direction: column; gap: 12px; }
        .note-item { background: var(--bg); border-radius: var(--radius-md); padding: 12px; border-right: 3px solid var(--primary); }
        .note-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .note-author { font-size: 12px; font-weight: 600; color: var(--secondary); }
        .note-date { font-size: 11px; color: var(--text-light); }
        .note-text { font-size: 14px; line-height: 1.5; }
        .note-input-container { display: flex; gap: 8px; margin-top: 12px; }
        .note-input { flex: 1; padding: 10px 14px; border: 1px solid var(--border); border-radius: var(--radius-md); font-family: var(--font-body); font-size: 14px; resize: none; }
        .note-input:focus { outline: none; border-color: var(--primary); }
        .quick-actions { display: flex; gap: 8px; margin-top: 16px; }
        .quick-action-btn { flex: 1; padding: 12px; border: 1px solid var(--border); border-radius: var(--radius-md); background: white; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; gap: 6px; }
        .quick-action-btn:hover { border-color: var(--primary); background: var(--bg); }
        .quick-action-btn span:first-child { font-size: 20px; }
        .quick-action-btn span:last-child { font-size: 11px; color: var(--text-light); }
        .status-selector { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .status-option { padding: 12px; border: 2px solid var(--border); border-radius: var(--radius-md); cursor: pointer; transition: all 0.2s; text-align: center; font-size: 13px; font-weight: 500; }
        .status-option:hover { border-color: var(--primary); }
        .status-option.selected { border-color: var(--primary); background: rgba(6,214,160,0.1); }
        .reason-selector { display: flex; flex-direction: column; gap: 8px; margin-top: 12px; }
        .reason-option { padding: 14px; border: 1px solid var(--border); border-radius: var(--radius-md); cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 12px; }
        .reason-option:hover { border-color: var(--primary); background: var(--bg); }
        .reason-icon { width: 36px; height: 36px; border-radius: var(--radius-sm); background: var(--bg); display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .template-card { padding: 14px; border: 1px solid var(--border); border-radius: var(--radius-md); margin-bottom: 10px; cursor: pointer; transition: all 0.2s; }
        .template-card:hover { border-color: var(--primary); background: var(--bg); }
        .template-card.selected { border-color: var(--primary); background: rgba(6,214,160,0.1); }
        .template-title { font-weight: 600; font-size: 14px; margin-bottom: 6px; }
        .template-preview { font-size: 13px; color: var(--text-light); line-height: 1.4; white-space: pre-line; }
        .call-log-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg); border-radius: var(--radius-md); margin-bottom: 8px; }
        .call-log-icon { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; }
        .call-log-icon.call { background: rgba(16,185,129,0.1); }
        .call-log-icon.whatsapp { background: rgba(37,211,102,0.1); }
        .call-log-info { flex: 1; }
        .call-log-type { font-weight: 500; font-size: 14px; }
        .call-log-time { font-size: 12px; color: var(--text-light); }
        .kanban-container { display: flex; gap: 16px; overflow-x: auto; padding-bottom: 20px; }
        .kanban-column { min-width: 280px; max-width: 280px; background: var(--bg); border-radius: var(--radius-lg); padding: 16px; }
        .kanban-column-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid var(--border); }
        .kanban-column-title { font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 8px; }
        .kanban-column-count { background: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: 600; }
        .kanban-card { background: white; border-radius: var(--radius-md); padding: 14px; margin-bottom: 10px; box-shadow: var(--shadow-sm); cursor: pointer; transition: all 0.2s; border: 1px solid var(--border); }
        .kanban-card:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); }
        .kanban-card-name { font-weight: 600; font-size: 14px; margin-bottom: 6px; }
        .kanban-card-business { font-size: 12px; color: var(--text-light); margin-bottom: 10px; }
        .kanban-card-footer { display: flex; justify-content: space-between; align-items: center; }
        .kanban-card-date { font-size: 11px; color: var(--text-light); }
        .task-item { display: flex; align-items: center; gap: 12px; padding: 14px; background: white; border-radius: var(--radius-md); margin-bottom: 10px; border: 1px solid var(--border); transition: all 0.2s; }
        .task-item:hover { box-shadow: var(--shadow-sm); }
        .task-item.completed { opacity: 0.6; background: var(--bg); }
        .task-checkbox { width: 22px; height: 22px; border: 2px solid var(--border); border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0; }
        .task-checkbox:hover { border-color: var(--primary); }
        .task-checkbox.checked { background: var(--primary); border-color: var(--primary); color: white; }
        .task-content { flex: 1; }
        .task-title { font-weight: 500; font-size: 14px; }
        .task-title.completed { text-decoration: line-through; color: var(--text-light); }
        .task-meta { font-size: 12px; color: var(--text-light); margin-top: 4px; }
        .task-priority { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
        .task-priority.high { background: rgba(239,68,68,0.1); color: #DC2626; }
        .task-priority.medium { background: rgba(245,158,11,0.1); color: #D97706; }
        .task-priority.low { background: rgba(107,114,128,0.1); color: #6B7280; }
        .report-card { background: white; border-radius: var(--radius-lg); padding: 24px; border: 1px solid var(--border); margin-bottom: 20px; }
        .report-card-title { font-size: 16px; font-weight: 600; margin-bottom: 20px; }
        .chart-bar-container { display: flex; flex-direction: column; gap: 12px; }
        .chart-bar-item { display: flex; align-items: center; gap: 12px; }
        .chart-bar-label { width: 100px; font-size: 13px; }
        .chart-bar-track { flex: 1; height: 24px; background: var(--bg); border-radius: var(--radius-sm); overflow: hidden; }
        .chart-bar-fill { height: 100%; border-radius: var(--radius-sm); transition: width 0.5s ease; }
        .chart-bar-value { width: 50px; text-align: left; font-weight: 600; font-size: 13px; }
        .reminder-card { background: linear-gradient(135deg, var(--warning) 0%, #F97316 100%); color: white; padding: 16px; border-radius: var(--radius-md); margin-bottom: 12px; }
        .reminder-card h4 { font-size: 14px; margin-bottom: 4px; }
        .reminder-card p { font-size: 12px; opacity: 0.9; }
        .empty-state { text-align: center; padding: 60px 20px; }
        .empty-state-icon { font-size: 48px; margin-bottom: 16px; }
        .empty-state-title { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 400; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .modal { background: white; border-radius: var(--radius-xl); width: 100%; max-width: 480px; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-family: var(--font-display); font-size: 18px; font-weight: 600; }
        .modal-body { padding: 24px; }
        .modal-footer { padding: 16px 24px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 12px; }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 13px; font-weight: 500; margin-bottom: 6px; }
        .form-input { width: 100%; padding: 10px 14px; border: 1px solid var(--border); border-radius: var(--radius-md); font-family: var(--font-body); font-size: 14px; }
        .form-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(6,214,160,0.1); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .toast-container { position: fixed; bottom: 24px; left: 24px; z-index: 500; display: flex; flex-direction: column; gap: 12px; }
        .toast { background: var(--navy); color: white; padding: 14px 20px; border-radius: var(--radius-md); box-shadow: var(--shadow-lg); display: flex; align-items: center; gap: 12px; min-width: 300px; }
        .toast.success { border-right: 4px solid var(--success); }
        .toast.error { border-right: 4px solid var(--danger); }
        .add-task-section { background: var(--bg); border-radius: var(--radius-md); padding: 16px; margin-top: 16px; }
        .add-task-section h4 { font-size: 14px; font-weight: 600; margin-bottom: 12px; }
        .loading-spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.9); display: flex; align-items: center; justify-content: center; z-index: 600; }
        
        /* Notification Bell Styles */
        .notification-bell { position: relative; cursor: pointer; padding: 8px; border-radius: var(--radius-md); transition: all 0.2s; }
        .notification-bell:hover { background: rgba(255,255,255,0.1); }
        .notification-bell-icon { font-size: 22px; }
        .notification-badge { position: absolute; top: 2px; right: 2px; background: var(--danger); color: white; font-size: 10px; font-weight: 700; min-width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .notification-dropdown { position: absolute; top: calc(100% + 8px); left: 0; width: 360px; background: white; border-radius: var(--radius-lg); box-shadow: var(--shadow-xl); border: 1px solid var(--border); z-index: 300; max-height: 480px; overflow: hidden; display: flex; flex-direction: column; }
        .notification-dropdown-header { padding: 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .notification-dropdown-title { font-weight: 600; font-size: 16px; color: var(--text); }
        .notification-tabs { display: flex; border-bottom: 1px solid var(--border); }
        .notification-tab { flex: 1; padding: 12px; text-align: center; font-size: 13px; font-weight: 500; color: var(--text-light); cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; }
        .notification-tab:hover { color: var(--text); background: var(--bg); }
        .notification-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        .notification-list { flex: 1; overflow-y: auto; }
        .notification-item { padding: 14px 16px; border-bottom: 1px solid var(--border); cursor: pointer; transition: all 0.2s; display: flex; gap: 12px; align-items: flex-start; }
        .notification-item:hover { background: var(--bg); }
        .notification-item.unread { background: rgba(6,214,160,0.05); }
        .notification-item-icon { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0; }
        .notification-item-icon.task { background: rgba(245,158,11,0.15); }
        .notification-item-icon.mention { background: rgba(59,130,246,0.15); }
        .notification-item-icon.lead { background: rgba(139,92,246,0.15); }
        .notification-item-content { flex: 1; min-width: 0; }
        .notification-item-title { font-size: 14px; font-weight: 500; color: var(--text); margin-bottom: 2px; }
        .notification-item-message { font-size: 12px; color: var(--text-light); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .notification-item-time { font-size: 11px; color: var(--text-light); margin-top: 4px; }
        .notification-empty { padding: 40px 20px; text-align: center; color: var(--text-light); }
        .notification-empty-icon { font-size: 40px; margin-bottom: 12px; }
        .mark-all-read { font-size: 12px; color: var(--primary); cursor: pointer; }
        .mark-all-read:hover { text-decoration: underline; }
        
        /* Mention tag style */
        .mention-tag { background: rgba(59,130,246,0.15); color: #2563EB; padding: 2px 6px; border-radius: 4px; font-weight: 500; }
        
        /* Delete zone */
        .delete-zone { margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border); }
        .delete-btn { width: 100%; background: rgba(239,68,68,0.1); color: var(--danger); border: 1px solid rgba(239,68,68,0.3); }
        .delete-btn:hover { background: var(--danger); color: white; }
        
        /* Confirm Modal */
        .confirm-modal-body { text-align: center; padding: 20px; }
        .confirm-modal-icon { font-size: 48px; margin-bottom: 16px; }
        .confirm-modal-title { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
        .confirm-modal-text { color: var(--text-light); font-size: 14px; }
        
        @media (max-width: 1024px) { .sidebar { width: 72px; padding: 16px 8px; } .sidebar-logo, .sidebar-subtitle, .nav-item span:not(.nav-item-icon), .user-info, .nav-submenu { display: none; } .nav-item { justify-content: center; padding: 12px; } .main-content { margin-right: 72px; } .lead-panel { width: 100%; } .notification-dropdown { width: 300px; } }
        @media (max-width: 768px) { .sidebar { display: none; } .main-content { margin-right: 0; padding: 16px; } .stats-grid { grid-template-columns: repeat(2, 1fr); } .kanban-container { flex-direction: column; } .kanban-column { min-width: 100%; max-width: 100%; } }
        .logout-btn { background: rgba(255,255,255,0.1); border: none; cursor: pointer; font-size: 16px; padding: 8px 10px; border-radius: 6px; transition: all 0.2s; }
        .logout-btn:hover { background: rgba(239,68,68,0.3); }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">

        const { useState, useEffect, useMemo, useRef } = React;
        const { motion, AnimatePresence } = Motion;

        const SUPABASE_URL = 'https://tqxrahpbidlctyttpffc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRxeHJhaHBiaWRsY3R5dHRwZmZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4NTk3MzQsImV4cCI6MjA4MzQzNTczNH0.tmh9_GzWJhIcRoS3L6gpCX95_eZrkIR7hy3gOl9Qd2s';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // === AUTH CHECK - START ===
        const checkAuth = () => {
            const user = localStorage.getItem('crm_user');
            if (!user) {
                window.location.href = 'login.html';
                return null;
            }
            return JSON.parse(user);
        };

        const logout = () => {
            localStorage.removeItem('crm_user');
            window.location.href = 'login.html';
        };

        const currentUser = checkAuth();
        if (!currentUser) {
            document.body.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100vh;font-family:Heebo;font-size:18px;">××¢×‘×™×¨ ×œ×”×ª×—×‘×¨×•×ª...</div>';
        }
        // === AUTH CHECK - END ===

        // Team members for mentions
        const TEAM_MEMBERS = [
            { id: 'aebd4b85-2a22-4d22-af8b-b9bc4be5dab8', username: 'ariel', displayName: '××¨×™××œ' },
            { id: '54be9442-260f-42e6-b566-6c17b9f93d49', username: 'arbel', displayName: '××¨×‘×œ' }
        ];

        const STATUS_CONFIG = {
            new: { label: '×—×“×©', color: '#8B5CF6', icon: 'âœ¨' },
            followup_initial: { label: '×¤×•×œ×•××¤ ×¨××©×•× ×™', color: '#F59E0B', icon: 'ğŸ“' },
            followup_qualified: { label: '×¤×•×œ×•××¤ ××™×›×•×ª×™', color: '#0EA5E9', icon: 'â­' },
            interested: { label: '××¢×•× ×™×™×Ÿ', color: '#10B981', icon: 'ğŸ‘' },
            demo: { label: '×”×“×’××”', color: '#3B82F6', icon: 'ğŸ¯' },
            closed_won: { label: '× ×¡×’×¨', color: '#059669', icon: 'ğŸ‰' },
            not_interested: { label: '×œ× ××¢×•× ×™×™×Ÿ', color: '#EF4444', icon: 'âŒ' }
        };

        const REJECTION_REASONS = {
            expensive: { label: '×™×§×¨ ×œ×™', icon: 'ğŸ’°' },
            bad_timing: { label: '×˜×™×™××™× ×’ ×œ× ×˜×•×‘', icon: 'â°' },
            not_connected: { label: '×œ× ×”×ª×—×‘×¨ ×œ××•×¦×¨', icon: 'ğŸ¤·' }
        };

        const SOURCE_CONFIG = {
            facebook: { label: '×¤×™×™×¡×‘×•×§', icon: 'ğŸ“˜', color: '#1877F2' },
            instagram: { label: '××™× ×¡×˜×’×¨×', icon: 'ğŸ“¸', color: '#E1306C' },
            google: { label: '×’×•×’×œ', icon: 'ğŸ”', color: '#4285F4' },
            website: { label: '××ª×¨', icon: 'ğŸŒ', color: '#059669' },
            referral: { label: '×”××œ×¦×”', icon: 'ğŸ‘¥', color: '#7C3AED' },
            organic: { label: '××•×¨×’× ×™', icon: 'ğŸŒ±', color: '#6B7280' }
        };

        const WHATSAPP_TEMPLATES = [
            { id: 'intro', title: '×”×•×“×¢×ª ×”×™×›×¨×•×ª', message: '×”×™×™ [×©×]! ğŸ‘‹\n×× ×™ ×-EasyChat, ×¨××™×ª×™ ×©×”×ª×¢× ×™×™× ×ª ×‘×©×™×¨×•×ª ×©×œ× ×•.\n××©××— ×œ×¡×¤×¨ ×œ×š ×§×¦×ª ×™×•×ª×¨ - ××ª×™ × ×•×— ×œ×š ×œ×“×‘×¨?' },
            { id: 'followup', title: '×¤×•×œ×•××¤ ×¨××©×•×Ÿ', message: '×”×™×™ [×©×], ××” ×©×œ×•××š? ğŸ˜Š\n×¨×¦×™×ª×™ ×œ×¢×§×•×‘ ×¢×œ ×”×©×™×—×” ×©×œ× ×•.\n×”×™×” ×œ×š ×–××Ÿ ×œ×—×©×•×‘ ×¢×œ ×”×”×¦×¢×”?' },
            { id: 'demo_invite', title: '×”×–×× ×” ×œ×”×“×’××”', message: '×”×™×™ [×©×]! ğŸ¯\n××©××— ×œ×”×¨××•×ª ×œ×š ×‘×“×™×•×§ ××™×š ×”××¢×¨×›×ª ×¢×•×‘×“×ª.\n××ª×™ ×™×”×™×” ×œ×š 15 ×“×§×•×ª ×¤× ×•×™×•×ª ×œ×”×“×’××” ×§×¦×¨×”?' },
            { id: 'closing', title: '×œ×§×¨××ª ×¡×’×™×¨×”', message: '×”×™×™ [×©×]! ğŸ‰\n×©××— ×©××”×‘×ª ××ª ××” ×©×¨××™×ª!\n×¨×•×¦×” ×©× ×ª×§×“× ×œ×”×¨×©××”?' },
            { id: 'reengagement', title: '×—×–×¨×” ×œ×œ×§×•×— ×§×¨', message: '×”×™×™ [×©×], ××” × ×©××¢? ğŸ‘‹\n×¢×‘×¨ ×§×¦×ª ×–××Ÿ ×××– ×©×“×™×‘×¨× ×•...\n×™×© ×œ× ×• ×¢×“×›×•× ×™× ×—×“×©×™× ×©×—×©×‘×ª×™ ×©×™×¢× ×™×™× ×• ××•×ª×š!' }
        ];

        const calculateLeadScore = (lead) => {
            let score = 0;
            const days = Math.floor((Date.now() - new Date(lead.created_at)) / 86400000);
            if (days <= 1) score += 30; else if (days <= 3) score += 20; else if (days <= 7) score += 10;
            if (lead.status === 'interested' || lead.status === 'demo') score += 40;
            else if (lead.status === 'followup_qualified') score += 30;
            else if (lead.status === 'followup_initial') score += 20;
            else if (lead.status === 'new') score += 15;
            if (lead.call_logs && lead.call_logs.length) score += Math.min(lead.call_logs.length * 5, 20);
            if (lead.notes && lead.notes.length) score += Math.min(lead.notes.length * 3, 10);
            return Math.min(score, 100);
        };

        const getScoreLevel = (score) => {
            if (score >= 60) return { level: 'hot', label: 'ğŸ”¥ğŸ”¥ğŸ”¥ ×—×' };
            if (score >= 35) return { level: 'warm', label: 'ğŸ”¥ğŸ”¥ ×¤×•×©×¨' };
            return { level: 'cold', label: 'ğŸ”¥ ×§×¨' };
        };

        const getDaysSinceLastContact = (lead) => {
            if (!lead.call_logs || !lead.call_logs.length) return Math.floor((Date.now() - new Date(lead.created_at)) / 86400000);
            return Math.floor((Date.now() - new Date(lead.call_logs[lead.call_logs.length - 1].created_at)) / 86400000);
        };

        const formatTimeAgo = (date) => {
            const now = new Date();
            const past = new Date(date);
            const diffMs = now - past;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return '×¢×›×©×™×•';
            if (diffMins < 60) return `×œ×¤× ×™ ${diffMins} ×“×§×•×ª`;
            if (diffHours < 24) return `×œ×¤× ×™ ${diffHours} ×©×¢×•×ª`;
            if (diffDays === 1) return '××ª××•×œ';
            if (diffDays < 7) return `×œ×¤× ×™ ${diffDays} ×™××™×`;
            return past.toLocaleDateString('he-IL');
        };

        const getUserDisplayName = (username) => {
            const member = TEAM_MEMBERS.find(m => m.username === username);
            return member ? member.displayName : username;
        };

        // Notification Bell Component
        const NotificationBell = ({ notifications, onMarkAsRead, onMarkAllAsRead, tasks }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [activeTab, setActiveTab] = useState('all');
            const dropdownRef = useRef(null);
            
            const unreadCount = notifications.filter(n => !n.is_read).length;
            
            // Get upcoming tasks (due today or overdue)
            const upcomingTasks = tasks.filter(t => {
                if (t.completed) return false;
                const dueDate = new Date(t.due_date);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                dueDate.setHours(0, 0, 0, 0);
                return dueDate <= today;
            });
            
            const filteredItems = activeTab === 'tasks' 
                ? upcomingTasks.map(t => ({ ...t, itemType: 'task' }))
                : activeTab === 'mentions'
                ? notifications.filter(n => n.type === 'mention' || n.type === 'task_assigned')
                : [...notifications, ...upcomingTasks.map(t => ({ ...t, itemType: 'task', type: 'task_reminder' }))].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            useEffect(() => {
                const handleClickOutside = (e) => {
                    if (dropdownRef.current && !dropdownRef.current.contains(e.target)) {
                        setIsOpen(false);
                    }
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);
            
            return (
                <div className="notification-bell" ref={dropdownRef}>
                    <div onClick={() => setIsOpen(!isOpen)}>
                        <span className="notification-bell-icon">ğŸ””</span>
                        {(unreadCount + upcomingTasks.length) > 0 && (
                            <span className="notification-badge">{unreadCount + upcomingTasks.length}</span>
                        )}
                    </div>
                    
                    {isOpen && (
                        <motion.div 
                            className="notification-dropdown"
                            initial={{ opacity: 0, y: -10 }}
                            animate={{ opacity: 1, y: 0 }}
                        >
                            <div className="notification-dropdown-header">
                                <span className="notification-dropdown-title">×”×ª×¨××•×ª</span>
                                {unreadCount > 0 && (
                                    <span className="mark-all-read" onClick={onMarkAllAsRead}>×¡××Ÿ ×”×›×œ ×›× ×§×¨×</span>
                                )}
                            </div>
                            
                            <div className="notification-tabs">
                                <div 
                                    className={`notification-tab ${activeTab === 'all' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('all')}
                                >
                                    ×”×›×œ
                                </div>
                                <div 
                                    className={`notification-tab ${activeTab === 'tasks' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('tasks')}
                                >
                                    ××©×™××•×ª ({upcomingTasks.length})
                                </div>
                                <div 
                                    className={`notification-tab ${activeTab === 'mentions' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('mentions')}
                                >
                                    ××–×›×•×¨×™×
                                </div>
                            </div>
                            
                            <div className="notification-list">
                                {filteredItems.length === 0 ? (
                                    <div className="notification-empty">
                                        <div className="notification-empty-icon">ğŸ‰</div>
                                        <div>××™×Ÿ ×”×ª×¨××•×ª ×—×“×©×•×ª</div>
                                    </div>
                                ) : (
                                    filteredItems.slice(0, 10).map((item, index) => (
                                        <div 
                                            key={item.id || index}
                                            className={`notification-item ${item.itemType !== 'task' && !item.is_read ? 'unread' : ''}`}
                                            onClick={() => {
                                                if (item.itemType !== 'task' && !item.is_read) {
                                                    onMarkAsRead(item.id);
                                                }
                                            }}
                                        >
                                            <div className={`notification-item-icon ${item.type === 'task_reminder' || item.itemType === 'task' ? 'task' : item.type === 'mention' || item.type === 'task_assigned' ? 'mention' : 'lead'}`}>
                                                {item.type === 'task_reminder' || item.itemType === 'task' ? 'â°' : item.type === 'mention' || item.type === 'task_assigned' ? 'ğŸ’¬' : 'âœ¨'}
                                            </div>
                                            <div className="notification-item-content">
                                                <div className="notification-item-title">
                                                    {item.itemType === 'task' ? item.title : item.title}
                                                </div>
                                                <div className="notification-item-message">
                                                    {item.itemType === 'task' 
                                                        ? (item.lead_name ? `ğŸ‘¤ ${item.lead_name}` : '××©×™××” ×›×œ×œ×™×ª')
                                                        : item.message
                                                    }
                                                </div>
                                                <div className="notification-item-time">
                                                    {formatTimeAgo(item.created_at || item.due_date)}
                                                </div>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        </motion.div>
                    )}
                </div>
            );
        };

        const Sidebar = ({ activeView, setActiveView, leads, statusFilter, setStatusFilter, notifications, tasks, onMarkAsRead, onMarkAllAsRead }) => {
            const [leadsExpanded, setLeadsExpanded] = useState(true);
            const statusCounts = useMemo(() => {
                const counts = {};
                Object.keys(STATUS_CONFIG).forEach(s => counts[s] = leads.filter(l => l.status === s).length);
                return counts;
            }, [leads]);

            const navItems = [
                { id: 'dashboard', icon: 'ğŸ“Š', label: '×“×©×‘×•×¨×“' },
                { id: 'leads', icon: 'ğŸ‘¥', label: '×œ×™×“×™×', expandable: true },
                { id: 'pipeline', icon: 'ğŸ“‹', label: 'Pipeline' },
                { id: 'tasks', icon: 'âœ…', label: '××©×™××•×ª' },
                { id: 'reports', icon: 'ğŸ“ˆ', label: '×“×•×—×•×ª' }
            ];

            return (
                <aside className="sidebar">
                    <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 8 }}>
                        <div className="sidebar-logo">EasyChat</div>
                        <NotificationBell 
                            notifications={notifications} 
                            tasks={tasks}
                            onMarkAsRead={onMarkAsRead}
                            onMarkAllAsRead={onMarkAllAsRead}
                        />
                    </div>
                    <div className="sidebar-subtitle">××¢×¨×›×ª × ×™×”×•×œ ×œ×™×“×™×</div>
                    <nav className="sidebar-nav">
                        {navItems.map(item => (
                            <div key={item.id}>
                                <div 
                                    className={`nav-item ${activeView === item.id ? 'active' : ''}`} 
                                    onClick={() => { 
                                        if (item.id === 'leads') { 
                                            setLeadsExpanded(!leadsExpanded); 
                                            setActiveView('leads'); 
                                            setStatusFilter('all'); 
                                        } else { 
                                            setActiveView(item.id); 
                                        } 
                                    }}
                                >
                                    {item.expandable ? (
                                        <div className="nav-item-expandable">
                                            <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                                                <span className="nav-item-icon">{item.icon}</span>
                                                <span>{item.label}</span>
                                            </div>
                                            <span className={`expand-icon ${leadsExpanded ? 'expanded' : ''}`}>â–¼</span>
                                        </div>
                                    ) : (
                                        <React.Fragment>
                                            <span className="nav-item-icon">{item.icon}</span>
                                            <span>{item.label}</span>
                                        </React.Fragment>
                                    )}
                                </div>
                                {item.id === 'leads' && (
                                    <div className={`nav-submenu ${leadsExpanded ? '' : 'collapsed'}`}>
                                        <div 
                                            className={`nav-submenu-item ${statusFilter === 'all' ? 'active' : ''}`} 
                                            onClick={() => { setActiveView('leads'); setStatusFilter('all'); }}
                                        >
                                            <span>ğŸ“‹ ×›×œ ×”×œ×™×“×™×</span>
                                            <span className="count">{leads.length}</span>
                                        </div>
                                        {Object.entries(STATUS_CONFIG).map(([status, config]) => (
                                            <div 
                                                key={status} 
                                                className={`nav-submenu-item ${statusFilter === status ? 'active' : ''}`} 
                                                onClick={() => { setActiveView('leads'); setStatusFilter(status); }}
                                            >
                                                <span>{config.icon} {config.label}</span>
                                                <span className="count">{statusCounts[status]}</span>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        ))}
                    </nav>
                    <div className="sidebar-user">
                        <div className="user-avatar">{currentUser && currentUser.username ? currentUser.username.charAt(0).toUpperCase() : '×'}</div>
                        <div className="user-info">
                            <div className="user-name">{currentUser ? getUserDisplayName(currentUser.username) : '××©×ª××©'}</div>
                            <div className="user-role">×× ×”×œ</div>
                        </div>
                        <button className="logout-btn" onClick={logout} title="×”×ª× ×ª×§">ğŸšª</button>
                    </div>
                </aside>
            );
        };

        const StatsCards = ({ leads }) => {
            const stats = [
                { label: '×¡×”×´×› ×œ×™×“×™×', value: leads.length, icon: 'ğŸ‘¥', color: 'blue' },
                { label: '×œ×™×“×™× ×—×“×©×™×', value: leads.filter(l => l.status === 'new').length, icon: 'âœ¨', color: 'purple' },
                { label: '×‘×¤×•×œ×•××¤', value: leads.filter(l => l.status && l.status.includes('followup')).length, icon: 'ğŸ“', color: 'yellow' },
                { label: '× ×¡×’×¨×•', value: leads.filter(l => l.status === 'closed_won').length, icon: 'ğŸ‰', color: 'green' }
            ];
            return (
                <div className="stats-grid">
                    {stats.map((s, i) => (
                        <motion.div key={i} className="stat-card" initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: i * 0.05 }}>
                            <div className="stat-card-header">
                                <span className="stat-card-label">{s.label}</span>
                                <div className={`stat-card-icon ${s.color}`}>{s.icon}</div>
                            </div>
                            <div className="stat-card-value">{s.value}</div>
                        </motion.div>
                    ))}
                </div>
            );
        };

        const LeadsTable = ({ leads, onSelectLead, searchQuery, statusFilter, sourceFilter }) => {
            const filtered = leads.filter(l => {
                if (searchQuery && !l.name.toLowerCase().includes(searchQuery.toLowerCase()) && !l.phone.includes(searchQuery)) return false;
                if (statusFilter !== 'all' && l.status !== statusFilter) return false;
                if (sourceFilter !== 'all' && l.source !== sourceFilter) return false;
                return true;
            });
            if (!filtered.length) return <div className="table-container"><div className="empty-state"><div className="empty-state-icon">ğŸ”</div><div className="empty-state-title">×œ× × ××¦××• ×œ×™×“×™×</div></div></div>;
            return (
                <div className="table-container">
                    <table className="table">
                        <thead>
                            <tr><th>×©×</th><th>×˜×œ×¤×•×Ÿ</th><th>×¡×•×’ ×¢×¡×§</th><th>×¡×˜×˜×•×¡</th><th>××§×•×¨</th><th>×—×•×</th></tr>
                        </thead>
                        <tbody>
                            {filtered.map((lead, i) => {
                                const score = calculateLeadScore(lead);
                                const scoreInfo = getScoreLevel(score);
                                return (
                                    <motion.tr key={lead.id} initial={{ opacity: 0 }} animate={{ opacity: 1 }} onClick={() => onSelectLead(lead)}>
                                        <td><strong>{lead.name}</strong></td>
                                        <td style={{ direction: 'ltr', textAlign: 'right' }}>{lead.phone}</td>
                                        <td>{lead.business_type}</td>
                                        <td><span className={`status-badge ${lead.status}`}><span className="status-dot"></span>{STATUS_CONFIG[lead.status] && STATUS_CONFIG[lead.status].label}</span></td>
                                        <td><span className={`source-badge ${lead.source}`}>{SOURCE_CONFIG[lead.source] && SOURCE_CONFIG[lead.source].icon} {SOURCE_CONFIG[lead.source] && SOURCE_CONFIG[lead.source].label}</span></td>
                                        <td><span className={`lead-score ${scoreInfo.level}`}>{scoreInfo.label}</span></td>
                                    </motion.tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>
            );
        };

        const ConfirmModal = ({ isOpen, onClose, onConfirm, title, message, confirmText, confirmType }) => {
            if (!isOpen) return null;
            return (
                <div className="modal-overlay" onClick={onClose}>
                    <motion.div className="modal" initial={{ opacity: 0, scale: 0.95 }} animate={{ opacity: 1, scale: 1 }} onClick={e => e.stopPropagation()} style={{ maxWidth: 400 }}>
                        <div className="modal-body confirm-modal-body">
                            <div className="confirm-modal-icon">âš ï¸</div>
                            <div className="confirm-modal-title">{title}</div>
                            <div className="confirm-modal-text">{message}</div>
                        </div>
                        <div className="modal-footer">
                            <button className="btn btn-secondary" onClick={onClose}>×‘×™×˜×•×œ</button>
                            <button className={`btn ${confirmType === 'danger' ? 'btn-danger' : 'btn-primary'}`} onClick={onConfirm}>{confirmText}</button>
                        </div>
                    </motion.div>
                </div>
            );
        };

        const LeadPanel = ({ lead, onClose, onUpdateLead, onAddNote, onLogCall, onAddTask, onDeleteLead, tasks, teamMembers }) => {
            const [activeTab, setActiveTab] = useState('details');
            const [newNote, setNewNote] = useState('');
            const [selectedStatus, setSelectedStatus] = useState(lead ? lead.status : 'new');
            const [selectedTemplate, setSelectedTemplate] = useState(null);
            const [showRejection, setShowRejection] = useState(false);
            const [showAddTask, setShowAddTask] = useState(false);
            const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
            const [newTask, setNewTask] = useState({ title: '', date: '', time: '', priority: 'medium', assigned_to: '' });

            useEffect(() => { 
                if (lead) { 
                    setSelectedStatus(lead.status); 
                    setActiveTab('details'); 
                    setShowAddTask(false);
                    setShowDeleteConfirm(false);
                    setNewTask({ title: '', date: new Date().toISOString().split('T')[0], time: '10:00', priority: 'medium', assigned_to: '' }); 
                } 
            }, [lead]);

            const handleWhatsApp = (template) => {
                if (!lead) return;
                const phone = lead.phone.replace(/\D/g, '');
                const phoneNumber = phone.startsWith('0') ? '972' + phone.slice(1) : phone;
                let url = 'https://wa.me/' + phoneNumber;
                if (template) url += '?text=' + encodeURIComponent(template.message.replace('[×©×]', lead.name.split(' ')[0]));
                window.open(url, '_blank');
                onLogCall(lead.id, 'whatsapp');
            };

            const handleCall = () => { 
                if (!lead) return;
                window.location.href = 'tel:' + lead.phone; 
                onLogCall(lead.id, 'call'); 
            };

            const handleStatusChange = (status) => {
                setSelectedStatus(status);
                if (status === 'not_interested') setShowRejection(true);
                else { setShowRejection(false); onUpdateLead(lead.id, { status: status }); }
            };

            const handleAddTask = () => {
                if (!newTask.title.trim() || !newTask.date) return;
                onAddTask({
                    title: newTask.title,
                    lead_id: lead.id,
                    lead_name: lead.name,
                    due_date: newTask.date,
                    due_time: newTask.time,
                    priority: newTask.priority,
                    assigned_to: newTask.assigned_to || null
                });
                setNewTask({ title: '', date: new Date().toISOString().split('T')[0], time: '10:00', priority: 'medium', assigned_to: '' });
                setShowAddTask(false);
            };

            const handleDelete = () => {
                onDeleteLead(lead.id);
                setShowDeleteConfirm(false);
                onClose();
            };

            if (!lead) return null;
            const score = calculateLeadScore(lead);
            const scoreInfo = getScoreLevel(score);
            const daysSince = getDaysSinceLastContact(lead);
            const leadTasks = tasks.filter(t => t.lead_id === lead.id);

            return (
                <React.Fragment>
                    <div className={`panel-overlay ${lead ? 'open' : ''}`} onClick={onClose} />
                    <motion.aside className={`lead-panel ${lead ? 'open' : ''}`} initial={{ x: '-100%' }} animate={{ x: lead ? 0 : '-100%' }}>
                        <div className="panel-header">
                            <div>
                                <h2 className="panel-title">{lead.name}</h2>
                                <span className={`lead-score ${scoreInfo.level}`}>{scoreInfo.label}</span>
                            </div>
                            <button className="panel-close" onClick={onClose}>âœ•</button>
                        </div>
                        <div className="panel-tabs">
                            <div className={`panel-tab ${activeTab === 'details' ? 'active' : ''}`} onClick={() => setActiveTab('details')}>×¤×¨×˜×™×</div>
                            <div className={`panel-tab ${activeTab === 'activity' ? 'active' : ''}`} onClick={() => setActiveTab('activity')}>×¤×¢×™×œ×•×ª</div>
                            <div className={`panel-tab ${activeTab === 'templates' ? 'active' : ''}`} onClick={() => setActiveTab('templates')}>×ª×‘× ×™×•×ª</div>
                        </div>
                        <div className="panel-content">
                            {daysSince >= 3 && lead.status !== 'closed_won' && lead.status !== 'not_interested' && (
                                <div className="reminder-card">
                                    <h4>âš ï¸ ×œ× ×”×™×” ×§×©×¨ {daysSince} ×™××™×</h4>
                                    <p>××•××œ×¥ ×œ×™×¦×•×¨ ×§×©×¨</p>
                                </div>
                            )}
                            <div className="quick-actions">
                                <button className="quick-action-btn" onClick={() => handleWhatsApp(null)}>
                                    <span>ğŸ’¬</span><span>WhatsApp</span>
                                </button>
                                <button className="quick-action-btn" onClick={handleCall}>
                                    <span>ğŸ“</span><span>×”×ª×§×©×¨</span>
                                </button>
                                <button className="quick-action-btn" onClick={() => setActiveTab('templates')}>
                                    <span>ğŸ“</span><span>×ª×‘× ×™×•×ª</span>
                                </button>
                                <button className="quick-action-btn" onClick={() => setShowAddTask(!showAddTask)}>
                                    <span>ğŸ“…</span><span>××©×™××”</span>
                                </button>
                            </div>
                            
                            {activeTab === 'details' && (
                                <React.Fragment>
                                    {showAddTask && (
                                        <div className="add-task-section">
                                            <h4>ğŸ“… ×”×•×¡×¤×ª ××©×™××” ×—×“×©×”</h4>
                                            <div className="form-group">
                                                <label className="form-label">×ª×™××•×¨ ×”××©×™××”</label>
                                                <input className="form-input" placeholder="×œ×“×•×’××”: ×œ×—×–×•×¨ ××œ ×”×œ×™×“ ×‘×©×¢×” 13:00" value={newTask.title} onChange={e => setNewTask({...newTask, title: e.target.value})} />
                                            </div>
                                            <div className="form-row">
                                                <div className="form-group">
                                                    <label className="form-label">×ª××¨×™×š</label>
                                                    <input type="date" className="form-input" value={newTask.date} onChange={e => setNewTask({...newTask, date: e.target.value})} />
                                                </div>
                                                <div className="form-group">
                                                    <label className="form-label">×©×¢×”</label>
                                                    <input type="time" className="form-input" value={newTask.time} onChange={e => setNewTask({...newTask, time: e.target.value})} />
                                                </div>
                                            </div>
                                            <div className="form-row">
                                                <div className="form-group">
                                                    <label className="form-label">×¢×“×™×¤×•×ª</label>
                                                    <select className="form-input" value={newTask.priority} onChange={e => setNewTask({...newTask, priority: e.target.value})}>
                                                        <option value="high">ğŸ”´ ×’×‘×•×”×”</option>
                                                        <option value="medium">ğŸŸ¡ ×‘×™× ×•× ×™×ª</option>
                                                        <option value="low">âšª × ××•×›×”</option>
                                                    </select>
                                                </div>
                                                <div className="form-group">
                                                    <label className="form-label">×”×§×¦×” ×œ</label>
                                                    <select className="form-input" value={newTask.assigned_to} onChange={e => setNewTask({...newTask, assigned_to: e.target.value})}>
                                                        <option value="">×‘×—×¨ ×—×‘×¨ ×¦×•×•×ª</option>
                                                        {TEAM_MEMBERS.map(m => (
                                                            <option key={m.id} value={m.id}>{m.displayName}</option>
                                                        ))}
                                                    </select>
                                                </div>
                                            </div>
                                            <button className="btn btn-primary" style={{width: '100%'}} onClick={handleAddTask}>â• ×”×•×¡×£ ××©×™××”</button>
                                        </div>
                                    )}

                                    {leadTasks.length > 0 && (
                                        <div className="panel-section" style={{ marginTop: 16 }}>
                                            <div className="panel-section-title">××©×™××•×ª ×œ×œ×™×“ ×–×” ({leadTasks.length})</div>
                                            {leadTasks.map(task => {
                                                const assignedMember = TEAM_MEMBERS.find(m => m.id === task.assigned_to);
                                                return (
                                                    <div key={task.id} style={{ background: 'var(--bg)', padding: '10px 12px', borderRadius: '8px', marginBottom: '8px', borderRight: '3px solid ' + (task.priority === 'high' ? '#EF4444' : task.priority === 'medium' ? '#F59E0B' : '#6B7280') }}>
                                                        <div style={{ fontWeight: 500, fontSize: '14px' }}>{task.title}</div>
                                                        <div style={{ fontSize: '12px', color: 'var(--text-light)', marginTop: '4px' }}>
                                                            ğŸ“… {new Date(task.due_date).toLocaleDateString('he-IL')} {task.due_time && ('â° ' + task.due_time)}
                                                            {assignedMember && <span className="mention-tag" style={{ marginRight: 8 }}>@{assignedMember.displayName}</span>}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}

                                    <div className="panel-section" style={{ marginTop: 24 }}>
                                        <div className="panel-section-title">×¤×¨×˜×™×</div>
                                        <div className="info-grid">
                                            <div className="info-item"><div className="info-label">×˜×œ×¤×•×Ÿ</div><div className="info-value" style={{ direction: 'ltr', textAlign: 'right' }}>{lead.phone}</div></div>
                                            <div className="info-item"><div className="info-label">×¡×•×’ ×¢×¡×§</div><div className="info-value">{lead.business_type}</div></div>
                                            <div className="info-item"><div className="info-label">××§×•×¨</div><div className="info-value"><span className={`source-badge ${lead.source}`}>{SOURCE_CONFIG[lead.source] && SOURCE_CONFIG[lead.source].icon} {SOURCE_CONFIG[lead.source] && SOURCE_CONFIG[lead.source].label}</span></div></div>
                                            <div className="info-item"><div className="info-label">×§×©×¨ ××—×¨×•×Ÿ</div><div className="info-value">{daysSince === 0 ? '×”×™×•×' : '×œ×¤× ×™ ' + daysSince + ' ×™××™×'}</div></div>
                                        </div>
                                    </div>
                                    <div className="panel-section">
                                        <div className="panel-section-title">×¡×˜×˜×•×¡</div>
                                        <div className="status-selector">
                                            {Object.entries(STATUS_CONFIG).map(([k, v]) => (
                                                <div key={k} className={`status-option ${selectedStatus === k ? 'selected' : ''}`} onClick={() => handleStatusChange(k)}>
                                                    {v.icon} {v.label}
                                                </div>
                                            ))}
                                        </div>
                                        {showRejection && (
                                            <div className="reason-selector">
                                                {Object.entries(REJECTION_REASONS).map(([k, v]) => (
                                                    <div key={k} className="reason-option" onClick={() => { onUpdateLead(lead.id, { status: 'not_interested', rejection_reason: k }); setShowRejection(false); }}>
                                                        <div className="reason-icon">{v.icon}</div>
                                                        <span>{v.label}</span>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                    <div className="panel-section">
                                        <div className="panel-section-title">×”×¢×¨×•×ª</div>
                                        <div className="notes-list">
                                            {lead.notes && lead.notes.length > 0 ? lead.notes.map(n => (
                                                <div key={n.id} className="note-item">
                                                    <div className="note-header">
                                                        <span className="note-author">{getUserDisplayName(n.author)}</span>
                                                        <span className="note-date">{new Date(n.created_at).toLocaleDateString('he-IL')}</span>
                                                    </div>
                                                    <div className="note-text">{n.text}</div>
                                                </div>
                                            )) : <div style={{ textAlign: 'center', padding: 20, color: 'var(--text-light)' }}>××™×Ÿ ×”×¢×¨×•×ª</div>}
                                        </div>
                                        <div className="note-input-container">
                                            <textarea className="note-input" placeholder="×”×•×¡×£ ×”×¢×¨×”..." rows={2} value={newNote} onChange={e => setNewNote(e.target.value)} />
                                            <button className="btn btn-primary" onClick={() => { if (newNote.trim()) { onAddNote(lead.id, newNote); setNewNote(''); } }} disabled={!newNote.trim()}>×”×•×¡×£</button>
                                        </div>
                                    </div>
                                    
                                    {/* Delete Zone */}
                                    <div className="delete-zone">
                                        <button className="btn delete-btn" onClick={() => setShowDeleteConfirm(true)}>
                                            ğŸ—‘ï¸ ××—×§ ×œ×™×“
                                        </button>
                                    </div>
                                </React.Fragment>
                            )}

                            {activeTab === 'activity' && (
                                <div className="panel-section">
                                    <div className="panel-section-title">×”×™×¡×˜×•×¨×™×™×ª ×§×©×¨</div>
                                    {lead.call_logs && lead.call_logs.length > 0 ? lead.call_logs.slice().reverse().map((l, i) => (
                                        <div key={i} className="call-log-item">
                                            <div className={`call-log-icon ${l.type}`}>{l.type === 'call' ? 'ğŸ“' : 'ğŸ’¬'}</div>
                                            <div className="call-log-info">
                                                <div className="call-log-type">{l.type === 'call' ? '×©×™×—×”' : 'WhatsApp'}</div>
                                                <div className="call-log-time">{new Date(l.created_at).toLocaleDateString('he-IL')}</div>
                                            </div>
                                        </div>
                                    )) : <div style={{ textAlign: 'center', padding: 20, color: 'var(--text-light)' }}>××™×Ÿ ×”×™×¡×˜×•×¨×™×”</div>}
                                </div>
                            )}

                            {activeTab === 'templates' && (
                                <div className="panel-section">
                                    <div className="panel-section-title">×ª×‘× ×™×•×ª WhatsApp</div>
                                    <p style={{ fontSize: 13, color: 'var(--text-light)', marginBottom: 16 }}>×‘×—×¨ ×ª×‘× ×™×ª ×•×©×œ×—</p>
                                    {WHATSAPP_TEMPLATES.map(t => (
                                        <div key={t.id} className={`template-card ${selectedTemplate && selectedTemplate.id === t.id ? 'selected' : ''}`} onClick={() => setSelectedTemplate(t)}>
                                            <div className="template-title">{t.title}</div>
                                            <div className="template-preview">{t.message.replace('[×©×]', lead.name.split(' ')[0])}</div>
                                        </div>
                                    ))}
                                    {selectedTemplate && <button className="btn btn-primary" style={{ width: '100%', marginTop: 16 }} onClick={() => { handleWhatsApp(selectedTemplate); setSelectedTemplate(null); }}>ğŸ’¬ ×©×œ×—</button>}
                                </div>
                            )}
                        </div>
                    </motion.aside>
                    
                    <ConfirmModal
                        isOpen={showDeleteConfirm}
                        onClose={() => setShowDeleteConfirm(false)}
                        onConfirm={handleDelete}
                        title="××—×™×§×ª ×œ×™×“"
                        message={`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×œ×™×“ "${lead.name}"? ×¤×¢×•×œ×” ×–×• ××™× ×” ×”×¤×™×›×”.`}
                        confirmText="××—×§"
                        confirmType="danger"
                    />
                </React.Fragment>
            );
        };

        const PipelineView = ({ leads, onSelectLead }) => {
            const columns = ['new', 'followup_initial', 'followup_qualified', 'interested', 'demo', 'closed_won'].map(s => ({ status: s, label: STATUS_CONFIG[s].label, icon: STATUS_CONFIG[s].icon }));
            return (
                <div>
                    <div className="page-header"><h1 className="page-title">ğŸ“‹ Pipeline</h1></div>
                    <div className="kanban-container">
                        {columns.map(col => {
                            const items = leads.filter(l => l.status === col.status);
                            return (
                                <div key={col.status} className="kanban-column">
                                    <div className="kanban-column-header">
                                        <div className="kanban-column-title"><span>{col.icon}</span><span>{col.label}</span></div>
                                        <span className="kanban-column-count">{items.length}</span>
                                    </div>
                                    {items.map(lead => {
                                        const scoreInfo = getScoreLevel(calculateLeadScore(lead));
                                        return (
                                            <motion.div key={lead.id} className="kanban-card" onClick={() => onSelectLead(lead)} whileHover={{ scale: 1.02 }}>
                                                <div className="kanban-card-name">{lead.name}</div>
                                                <div className="kanban-card-business">{lead.business_type}</div>
                                                <div className="kanban-card-footer">
                                                    <span className={`lead-score ${scoreInfo.level}`}>{scoreInfo.label}</span>
                                                    <span className="kanban-card-date">{new Date(lead.created_at).toLocaleDateString('he-IL', { day: 'numeric', month: 'short' })}</span>
                                                </div>
                                            </motion.div>
                                        );
                                    })}
                                    {!items.length && <div style={{ textAlign: 'center', padding: 20, color: 'var(--text-light)', fontSize: 13 }}>××™×Ÿ ×œ×™×“×™×</div>}
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const TasksView = ({ tasks, setTasks, leads, onAddTask, onToggleTask }) => {
            const [newTitle, setNewTitle] = useState('');
            const [newLeadId, setNewLeadId] = useState('');
            const [newPriority, setNewPriority] = useState('medium');
            const [newDate, setNewDate] = useState(new Date().toISOString().split('T')[0]);
            const [newTime, setNewTime] = useState('10:00');
            const [newAssignedTo, setNewAssignedTo] = useState('');
            
            const add = () => { 
                if (!newTitle.trim()) return; 
                const lead = leads.find(l => l.id === newLeadId); 
                onAddTask({
                    title: newTitle,
                    lead_id: newLeadId || null,
                    lead_name: lead ? lead.name : null,
                    due_date: newDate,
                    due_time: newTime,
                    priority: newPriority,
                    assigned_to: newAssignedTo || null
                });
                setNewTitle(''); 
                setNewLeadId('');
                setNewAssignedTo('');
            };
            
            const today = tasks.filter(t => new Date(t.due_date).toDateString() === new Date().toDateString());
            const upcoming = tasks.filter(t => new Date(t.due_date) > new Date() && new Date(t.due_date).toDateString() !== new Date().toDateString());
            
            return (
                <div>
                    <div className="page-header"><h1 className="page-title">âœ… ××©×™××•×ª</h1></div>
                    <div className="table-container" style={{ padding: 20, marginBottom: 24 }}>
                        <h3 style={{ marginBottom: 16 }}>â• ××©×™××” ×—×“×©×”</h3>
                        <div style={{ display: 'flex', gap: 12, flexWrap: 'wrap' }}>
                            <input className="form-input" placeholder="×ª×™××•×¨ ×”××©×™××”..." value={newTitle} onChange={e => setNewTitle(e.target.value)} style={{ flex: 2, minWidth: 200 }} />
                            <select className="filter-select" value={newLeadId} onChange={e => setNewLeadId(e.target.value)}>
                                <option value="">×œ×œ× ×œ×™×“</option>
                                {leads.map(l => <option key={l.id} value={l.id}>{l.name}</option>)}
                            </select>
                            <select className="filter-select" value={newAssignedTo} onChange={e => setNewAssignedTo(e.target.value)}>
                                <option value="">×”×§×¦×” ×œ...</option>
                                {TEAM_MEMBERS.map(m => <option key={m.id} value={m.id}>@{m.displayName}</option>)}
                            </select>
                            <input type="date" className="form-input" value={newDate} onChange={e => setNewDate(e.target.value)} style={{ width: 150 }} />
                            <input type="time" className="form-input" value={newTime} onChange={e => setNewTime(e.target.value)} style={{ width: 120 }} />
                            <select className="filter-select" value={newPriority} onChange={e => setNewPriority(e.target.value)}>
                                <option value="high">ğŸ”´ ×’×‘×•×”×”</option>
                                <option value="medium">ğŸŸ¡ ×‘×™× ×•× ×™×ª</option>
                                <option value="low">âšª × ××•×›×”</option>
                            </select>
                            <button className="btn btn-primary" onClick={add}>×”×•×¡×£</button>
                        </div>
                    </div>
                    <div className="table-container" style={{ padding: 20, marginBottom: 24 }}>
                        <h3 style={{ marginBottom: 16 }}>ğŸ“… ×”×™×•× ({today.filter(t => !t.completed).length})</h3>
                        {today.length ? today.map(t => {
                            const assignedMember = TEAM_MEMBERS.find(m => m.id === t.assigned_to);
                            return (
                                <div key={t.id} className={`task-item ${t.completed ? 'completed' : ''}`}>
                                    <div className={`task-checkbox ${t.completed ? 'checked' : ''}`} onClick={() => onToggleTask(t.id)}>{t.completed && 'âœ“'}</div>
                                    <div className="task-content">
                                        <div className={`task-title ${t.completed ? 'completed' : ''}`}>{t.title}</div>
                                        <div className="task-meta">
                                            {t.lead_name && ('ğŸ‘¤ ' + t.lead_name + ' â€¢ ')}
                                            {t.due_time && ('â° ' + t.due_time)}
                                            {assignedMember && <span className="mention-tag" style={{ marginRight: 8 }}>@{assignedMember.displayName}</span>}
                                        </div>
                                    </div>
                                    <span className={`task-priority ${t.priority}`}>{t.priority === 'high' ? '×’×‘×•×”×”' : t.priority === 'medium' ? '×‘×™× ×•× ×™×ª' : '× ××•×›×”'}</span>
                                </div>
                            );
                        }) : <div style={{ textAlign: 'center', padding: 20, color: 'var(--text-light)' }}>××™×Ÿ ××©×™××•×ª ×œ×”×™×•× ğŸ‰</div>}
                    </div>
                    {upcoming.length > 0 && (
                        <div className="table-container" style={{ padding: 20 }}>
                            <h3 style={{ marginBottom: 16 }}>ğŸ—“ï¸ ×§×¨×•×‘×•×ª ({upcoming.length})</h3>
                            {upcoming.slice(0, 5).map(t => {
                                const assignedMember = TEAM_MEMBERS.find(m => m.id === t.assigned_to);
                                return (
                                    <div key={t.id} className={`task-item ${t.completed ? 'completed' : ''}`}>
                                        <div className={`task-checkbox ${t.completed ? 'checked' : ''}`} onClick={() => onToggleTask(t.id)}>{t.completed && 'âœ“'}</div>
                                        <div className="task-content">
                                            <div className={`task-title ${t.completed ? 'completed' : ''}`}>{t.title}</div>
                                            <div className="task-meta">
                                                {t.lead_name && ('ğŸ‘¤ ' + t.lead_name + ' â€¢ ')}
                                                ğŸ“… {new Date(t.due_date).toLocaleDateString('he-IL')} {t.due_time && ('â° ' + t.due_time)}
                                                {assignedMember && <span className="mention-tag" style={{ marginRight: 8 }}>@{assignedMember.displayName}</span>}
                                            </div>
                                        </div>
                                        <span className={`task-priority ${t.priority}`}>{t.priority === 'high' ? '×’×‘×•×”×”' : t.priority === 'medium' ? '×‘×™× ×•× ×™×ª' : '× ××•×›×”'}</span>
                                    </div>
                                );
                            })}
                        </div>
                    )}
                </div>
            );
        };

        const ReportsView = ({ leads }) => {
            const statusData = Object.entries(STATUS_CONFIG).map(([s, c]) => ({ status: s, label: c.label, count: leads.filter(l => l.status === s).length, color: c.color }));
            const sourceData = Object.entries(SOURCE_CONFIG).map(([s, c]) => ({ source: s, label: c.label, count: leads.filter(l => l.source === s).length, color: c.color }));
            const max1 = Math.max(...statusData.map(s => s.count), 1);
            const max2 = Math.max(...sourceData.map(s => s.count), 1);
            return (
                <div>
                    <div className="page-header"><h1 className="page-title">ğŸ“ˆ ×“×•×—×•×ª</h1></div>
                    <StatsCards leads={leads} />
                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 24 }}>
                        <div className="report-card">
                            <div className="report-card-title">×¤×™×¨×•×˜ ×œ×¤×™ ×¡×˜×˜×•×¡</div>
                            <div className="chart-bar-container">
                                {statusData.map(i => (
                                    <div key={i.status} className="chart-bar-item">
                                        <div className="chart-bar-label">{i.label}</div>
                                        <div className="chart-bar-track"><div className="chart-bar-fill" style={{ width: ((i.count / max1) * 100) + '%', background: i.color }} /></div>
                                        <div className="chart-bar-value">{i.count}</div>
                                    </div>
                                ))}
                            </div>
                        </div>
                        <div className="report-card">
                            <div className="report-card-title">×¤×™×¨×•×˜ ×œ×¤×™ ××§×•×¨</div>
                            <div className="chart-bar-container">
                                {sourceData.map(i => (
                                    <div key={i.source} className="chart-bar-item">
                                        <div className="chart-bar-label">{i.label}</div>
                                        <div className="chart-bar-track"><div className="chart-bar-fill" style={{ width: ((i.count / max2) * 100) + '%', background: i.color }} /></div>
                                        <div className="chart-bar-value">{i.count}</div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const DashboardView = ({ leads, tasks }) => {
            const recent = [...leads].sort((a, b) => new Date(b.created_at) - new Date(a.created_at)).slice(0, 5);
            const hot = leads.filter(l => l.status !== 'closed_won' && l.status !== 'not_interested').map(l => ({ ...l, score: calculateLeadScore(l) })).sort((a, b) => b.score - a.score).slice(0, 5);
            const todayTasks = tasks.filter(t => new Date(t.due_date).toDateString() === new Date().toDateString() && !t.completed);
            return (
                <div>
                    <div className="page-header"><h1 className="page-title">ğŸ“Š ×“×©×‘×•×¨×“</h1></div>
                    <StatsCards leads={leads} />
                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 24 }}>
                        <div className="table-container" style={{ padding: 20 }}>
                            <h3 style={{ marginBottom: 16 }}>ğŸ”¥ ×œ×™×“×™× ×—××™×</h3>
                            {hot.map(l => {
                                const si = getScoreLevel(l.score);
                                return (
                                    <div key={l.id} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '12px 0', borderBottom: '1px solid var(--border)' }}>
                                        <div><strong>{l.name}</strong><div style={{ fontSize: 12, color: 'var(--text-light)' }}>{l.business_type}</div></div>
                                        <span className={`lead-score ${si.level}`}>{si.label}</span>
                                    </div>
                                );
                            })}
                        </div>
                        <div className="table-container" style={{ padding: 20 }}>
                            <h3 style={{ marginBottom: 16 }}>ğŸ†• ×œ×™×“×™× ××—×¨×•× ×™×</h3>
                            {recent.map(l => (
                                <div key={l.id} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '12px 0', borderBottom: '1px solid var(--border)' }}>
                                    <div><strong>{l.name}</strong><div style={{ fontSize: 12, color: 'var(--text-light)' }}>{l.business_type}</div></div>
                                    <span className={`status-badge ${l.status}`}>{STATUS_CONFIG[l.status] && STATUS_CONFIG[l.status].label}</span>
                                </div>
                            ))}
                        </div>
                        <div className="table-container" style={{ padding: 20 }}>
                            <h3 style={{ marginBottom: 16 }}>ğŸ“‹ ××©×™××•×ª ×œ×”×™×•× ({todayTasks.length})</h3>
                            {todayTasks.length ? todayTasks.map(t => {
                                const assignedMember = TEAM_MEMBERS.find(m => m.id === t.assigned_to);
                                return (
                                    <div key={t.id} style={{ padding: '12px 0', borderBottom: '1px solid var(--border)' }}>
                                        <div style={{ fontWeight: 500 }}>{t.title}</div>
                                        <div style={{ fontSize: 12, color: 'var(--text-light)' }}>
                                            {t.lead_name && ('ğŸ‘¤ ' + t.lead_name)} {t.due_time && ('â° ' + t.due_time)}
                                            {assignedMember && <span className="mention-tag" style={{ marginRight: 8 }}>@{assignedMember.displayName}</span>}
                                        </div>
                                    </div>
                                );
                            }) : <div style={{ textAlign: 'center', padding: 20, color: 'var(--text-light)' }}>××™×Ÿ ××©×™××•×ª ğŸ‰</div>}
                        </div>
                    </div>
                </div>
            );
        };

        const LeadsView = ({ leads, onSelectLead, onAddLead, statusFilter, setStatusFilter }) => {
            const [search, setSearch] = useState('');
            const [sourceFilter, setSourceFilter] = useState('all');
            return (
                <div>
                    <div className="page-header">
                        <h1 className="page-title">ğŸ‘¥ ×œ×™×“×™× {statusFilter !== 'all' && <span style={{ fontSize: 18, fontWeight: 400, marginRight: 8 }}>- {STATUS_CONFIG[statusFilter] && STATUS_CONFIG[statusFilter].icon} {STATUS_CONFIG[statusFilter] && STATUS_CONFIG[statusFilter].label}</span>}</h1>
                        <div className="header-actions">
                            <button className="btn btn-secondary" onClick={() => window.location.reload()}>ğŸ”„ ×¨×¢× ×Ÿ</button>
                            <button className="btn btn-primary" onClick={onAddLead}>+ ×œ×™×“ ×—×“×©</button>
                        </div>
                    </div>
                    <div className="filters-bar">
                        <input className="search-input" placeholder="×—×¤×© ×œ×¤×™ ×©× ××• ×˜×œ×¤×•×Ÿ..." value={search} onChange={e => setSearch(e.target.value)} />
                        <select className="filter-select" value={statusFilter} onChange={e => setStatusFilter(e.target.value)}>
                            <option value="all">×›×œ ×”×¡×˜×˜×•×¡×™×</option>
                            {Object.entries(STATUS_CONFIG).map(([k, v]) => <option key={k} value={k}>{v.icon} {v.label}</option>)}
                        </select>
                        <select className="filter-select" value={sourceFilter} onChange={e => setSourceFilter(e.target.value)}>
                            <option value="all">×›×œ ×”××§×•×¨×•×ª</option>
                            {Object.entries(SOURCE_CONFIG).map(([k, v]) => <option key={k} value={k}>{v.icon} {v.label}</option>)}
                        </select>
                        {(search || statusFilter !== 'all' || sourceFilter !== 'all') && <button className="btn btn-secondary btn-sm" onClick={() => { setSearch(''); setStatusFilter('all'); setSourceFilter('all'); }}>× ×§×”</button>}
                    </div>
                    <LeadsTable leads={leads} onSelectLead={onSelectLead} searchQuery={search} statusFilter={statusFilter} sourceFilter={sourceFilter} />
                </div>
            );
        };

        const AddLeadModal = ({ isOpen, onClose, onAdd }) => {
            const [form, setForm] = useState({ name: '', phone: '', business_type: '', source: 'organic' });
            const submit = (e) => { e.preventDefault(); onAdd(form); setForm({ name: '', phone: '', business_type: '', source: 'organic' }); onClose(); };
            if (!isOpen) return null;
            return (
                <div className="modal-overlay" onClick={onClose}>
                    <motion.div className="modal" initial={{ opacity: 0, scale: 0.95 }} animate={{ opacity: 1, scale: 1 }} onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <h3 className="modal-title">×œ×™×“ ×—×“×©</h3>
                            <button className="panel-close" onClick={onClose}>âœ•</button>
                        </div>
                        <form onSubmit={submit}>
                            <div className="modal-body">
                                <div className="form-group"><label className="form-label">×©× ××œ× *</label><input className="form-input" required value={form.name} onChange={e => setForm({ ...form, name: e.target.value })} /></div>
                                <div className="form-group"><label className="form-label">×˜×œ×¤×•×Ÿ *</label><input className="form-input" required type="tel" value={form.phone} onChange={e => setForm({ ...form, phone: e.target.value })} /></div>
                                <div className="form-group"><label className="form-label">×¡×•×’ ×¢×¡×§ *</label><input className="form-input" required value={form.business_type} onChange={e => setForm({ ...form, business_type: e.target.value })} /></div>
                                <div className="form-group"><label className="form-label">××§×•×¨</label><select className="form-input" value={form.source} onChange={e => setForm({ ...form, source: e.target.value })}>{Object.entries(SOURCE_CONFIG).map(([k, v]) => <option key={k} value={k}>{v.icon} {v.label}</option>)}</select></div>
                            </div>
                            <div className="modal-footer">
                                <button type="button" className="btn btn-secondary" onClick={onClose}>×‘×™×˜×•×œ</button>
                                <button type="submit" className="btn btn-primary">×”×•×¡×£</button>
                            </div>
                        </form>
                    </motion.div>
                </div>
            );
        };

        const Toast = ({ message, type, onClose }) => {
            useEffect(() => { const t = setTimeout(onClose, 3000); return () => clearTimeout(t); }, []);
            return (
                <motion.div className={`toast ${type}`} initial={{ opacity: 0, x: -50 }} animate={{ opacity: 1, x: 0 }} exit={{ opacity: 0, x: -50 }}>
                    <span>{type === 'success' ? 'âœ“' : 'âœ•'}</span>
                    <span>{message}</span>
                </motion.div>
            );
        };

        const App = () => {
            const [view, setView] = useState('dashboard');
            const [leads, setLeads] = useState([]);
            const [tasks, setTasks] = useState([]);
            const [notifications, setNotifications] = useState([]);
            const [selectedLead, setSelectedLead] = useState(null);
            const [showAdd, setShowAdd] = useState(false);
            const [statusFilter, setStatusFilter] = useState('all');
            const [toasts, setToasts] = useState([]);
            const [loading, setLoading] = useState(false);

            const toast = (msg, type) => setToasts(p => [...p, { id: Date.now(), message: msg, type: type || 'success' }]);

            // Load data from Supabase
            useEffect(() => {
                (async () => {
                    setLoading(true);
                    try { 
                        // Load leads
                        const { data: leadsData, error: leadsError } = await supabase.from('help_leads').select('*').order('created_at', { ascending: false }); 
                        if (leadsError) {
                            console.error('Supabase error loading leads:', leadsError);
                            toast('×©×’×™××” ×‘×˜×¢×™× ×ª ×œ×™×“×™×: ' + leadsError.message, 'error');
                        } else if (leadsData) {
                            setLeads(leadsData);
                            console.log('Loaded', leadsData.length, 'leads from Supabase');
                        }

                        // Load tasks
                        const { data: tasksData, error: tasksError } = await supabase.from('crm_tasks').select('*').order('due_date', { ascending: true });
                        if (tasksError) {
                            console.error('Supabase error loading tasks:', tasksError);
                        } else if (tasksData) {
                            setTasks(tasksData);
                            console.log('Loaded', tasksData.length, 'tasks from Supabase');
                        }

                        // Load notifications for current user
                        if (currentUser && currentUser.id) {
                            const { data: notifData, error: notifError } = await supabase
                                .from('crm_notifications')
                                .select('*')
                                .eq('user_id', currentUser.id)
                                .order('created_at', { ascending: false })
                                .limit(50);
                            if (notifError) {
                                console.error('Supabase error loading notifications:', notifError);
                            } else if (notifData) {
                                setNotifications(notifData);
                                console.log('Loaded', notifData.length, 'notifications');
                            }
                        }
                    } catch (e) { 
                        console.error('Error loading data:', e); 
                        toast('×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×', 'error');
                    }
                    setLoading(false);
                })();

                // Realtime subscriptions
                const leadsChannel = supabase.channel('leads-changes')
                    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'help_leads' }, p => { 
                        setLeads(prev => [p.new, ...prev]); 
                        toast('×œ×™×“ ×—×“×©: ' + p.new.name); 
                    })
                    .on('postgres_changes', { event: 'DELETE', schema: 'public', table: 'help_leads' }, p => {
                        setLeads(prev => prev.filter(l => l.id !== p.old.id));
                    })
                    .subscribe();

                const tasksChannel = supabase.channel('tasks-changes')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'crm_tasks' }, p => {
                        if (p.eventType === 'INSERT') {
                            setTasks(prev => [p.new, ...prev]);
                        } else if (p.eventType === 'UPDATE') {
                            setTasks(prev => prev.map(t => t.id === p.new.id ? p.new : t));
                        } else if (p.eventType === 'DELETE') {
                            setTasks(prev => prev.filter(t => t.id !== p.old.id));
                        }
                    })
                    .subscribe();

                const notifChannel = supabase.channel('notif-changes')
                    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'crm_notifications', filter: `user_id=eq.${currentUser?.id}` }, p => {
                        setNotifications(prev => [p.new, ...prev]);
                        // Show toast for new notification
                        if (p.new.type === 'task_assigned') {
                            toast('ğŸ“‹ ××©×™××” ×—×“×©×” ×”×•×§×¦×ª×” ×œ×š!');
                        } else if (p.new.type === 'mention') {
                            toast('ğŸ’¬ ××™×©×”×• ×ª×™×™×’ ××•×ª×š!');
                        }
                    })
                    .subscribe();

                return () => {
                    leadsChannel.unsubscribe();
                    tasksChannel.unsubscribe();
                    notifChannel.unsubscribe();
                };
            }, []);

            const updateLead = async (id, updates) => { 
                setLeads(p => p.map(l => l.id === id ? { ...l, ...updates } : l)); 
                if (selectedLead && selectedLead.id === id) setSelectedLead(p => ({ ...p, ...updates })); 
                try { 
                    const { error } = await supabase.from('help_leads').update(updates).eq('id', id); 
                    if (error) throw error;
                    toast('×¢×•×“×›×Ÿ'); 
                } catch (e) { 
                    console.error('Error updating lead:', e);
                    toast('×©×’×™××” ×‘×¢×“×›×•×Ÿ', 'error'); 
                } 
            };
            
            const addNote = async (id, text) => { 
                const note = { 
                    id: Date.now().toString(), 
                    text: text, 
                    author: currentUser ? currentUser.username : 'unknown',
                    created_at: new Date().toISOString() 
                }; 
                const lead = leads.find(l => l.id === id); 
                const notes = [...(lead.notes || []), note]; 
                setLeads(p => p.map(l => l.id === id ? { ...l, notes: notes } : l)); 
                if (selectedLead && selectedLead.id === id) setSelectedLead(p => ({ ...p, notes: notes })); 
                try { 
                    const { error } = await supabase.from('help_leads').update({ notes: notes }).eq('id', id); 
                    if (error) throw error;
                    toast('×”×¢×¨×” × ×•×¡×¤×”'); 
                } catch (e) { 
                    console.error('Error adding note:', e);
                    toast('×©×’×™××” ×‘×”×•×¡×¤×ª ×”×¢×¨×”', 'error'); 
                } 
            };
            
            const logCall = async (id, type) => { 
                const log = { id: Date.now().toString(), type: type, created_at: new Date().toISOString() }; 
                const lead = leads.find(l => l.id === id); 
                const logs = [...(lead.call_logs || []), log]; 
                setLeads(p => p.map(l => l.id === id ? { ...l, call_logs: logs } : l)); 
                if (selectedLead && selectedLead.id === id) setSelectedLead(p => ({ ...p, call_logs: logs })); 
                try { 
                    await supabase.from('help_leads').update({ call_logs: logs }).eq('id', id); 
                } catch (e) { 
                    console.error('Error logging call:', e);
                } 
            };
            
            const addLead = async (data) => { 
                const leadData = { 
                    ...data, 
                    status: 'new', 
                    notes: [], 
                    call_logs: [], 
                    created_at: new Date().toISOString() 
                };
                try { 
                    const { data: newLead, error } = await supabase.from('help_leads').insert([leadData]).select().single();
                    if (error) throw error;
                    setLeads(p => [newLead, ...p]);
                    toast('×œ×™×“ × ×•×¡×£ ×‘×”×¦×œ×—×” âœ…'); 
                } catch (e) { 
                    console.error('Error adding lead:', e);
                    toast('×©×’×™××” ×‘×©××™×¨×”', 'error'); 
                } 
            };

            const deleteLead = async (id) => {
                try {
                    const { error } = await supabase.from('help_leads').delete().eq('id', id);
                    if (error) throw error;
                    setLeads(p => p.filter(l => l.id !== id));
                    toast('×”×œ×™×“ × ××—×§');
                } catch (e) {
                    console.error('Error deleting lead:', e);
                    toast('×©×’×™××” ×‘××—×™×§×”', 'error');
                }
            };
            
            const addTask = async (taskData) => { 
                const task = { 
                    ...taskData, 
                    created_by: currentUser ? currentUser.id : null,
                    completed: false,
                    created_at: new Date().toISOString()
                };
                
                try {
                    const { data: newTask, error } = await supabase.from('crm_tasks').insert([task]).select().single();
                    if (error) throw error;
                    setTasks(p => [newTask, ...p]);
                    
                    // Create notification if task is assigned to someone else
                    if (taskData.assigned_to && taskData.assigned_to !== currentUser?.id) {
                        const assignedMember = TEAM_MEMBERS.find(m => m.id === taskData.assigned_to);
                        const creatorName = getUserDisplayName(currentUser?.username);
                        
                        await supabase.from('crm_notifications').insert([{
                            user_id: taskData.assigned_to,
                            type: 'task_assigned',
                            title: `${creatorName} ×”×§×¦×” ×œ×š ××©×™××”`,
                            message: taskData.title,
                            related_task_id: newTask.id,
                            related_lead_id: taskData.lead_id || null
                        }]);
                    }
                    
                    toast('××©×™××” × ×•×¡×¤×”'); 
                } catch (e) {
                    console.error('Error adding task:', e);
                    toast('×©×’×™××” ×‘×”×•×¡×¤×ª ××©×™××”', 'error');
                }
            };

            const toggleTask = async (id) => {
                const task = tasks.find(t => t.id === id);
                if (!task) return;
                
                const newCompleted = !task.completed;
                setTasks(p => p.map(t => t.id === id ? { ...t, completed: newCompleted } : t));
                
                try {
                    const { error } = await supabase.from('crm_tasks').update({ completed: newCompleted }).eq('id', id);
                    if (error) throw error;
                } catch (e) {
                    console.error('Error toggling task:', e);
                    // Revert on error
                    setTasks(p => p.map(t => t.id === id ? { ...t, completed: !newCompleted } : t));
                }
            };

            const markNotificationAsRead = async (id) => {
                setNotifications(p => p.map(n => n.id === id ? { ...n, is_read: true } : n));
                try {
                    await supabase.from('crm_notifications').update({ is_read: true }).eq('id', id);
                } catch (e) {
                    console.error('Error marking notification as read:', e);
                }
            };

            const markAllNotificationsAsRead = async () => {
                const unreadIds = notifications.filter(n => !n.is_read).map(n => n.id);
                setNotifications(p => p.map(n => ({ ...n, is_read: true })));
                try {
                    await supabase.from('crm_notifications').update({ is_read: true }).in('id', unreadIds);
                } catch (e) {
                    console.error('Error marking all notifications as read:', e);
                }
            };

            return (
                <div className="app-container">
                    <Sidebar 
                        activeView={view} 
                        setActiveView={setView} 
                        leads={leads} 
                        statusFilter={statusFilter} 
                        setStatusFilter={setStatusFilter}
                        notifications={notifications}
                        tasks={tasks}
                        onMarkAsRead={markNotificationAsRead}
                        onMarkAllAsRead={markAllNotificationsAsRead}
                    />
                    <main className="main-content">
                        {view === 'dashboard' && <DashboardView leads={leads} tasks={tasks} />}
                        {view === 'leads' && <LeadsView leads={leads} onSelectLead={setSelectedLead} onAddLead={() => setShowAdd(true)} statusFilter={statusFilter} setStatusFilter={setStatusFilter} />}
                        {view === 'pipeline' && <PipelineView leads={leads} onSelectLead={setSelectedLead} />}
                        {view === 'tasks' && <TasksView tasks={tasks} setTasks={setTasks} leads={leads} onAddTask={addTask} onToggleTask={toggleTask} />}
                        {view === 'reports' && <ReportsView leads={leads} />}
                    </main>
                    <LeadPanel 
                        lead={selectedLead} 
                        onClose={() => setSelectedLead(null)} 
                        onUpdateLead={updateLead} 
                        onAddNote={addNote} 
                        onLogCall={logCall} 
                        onAddTask={addTask}
                        onDeleteLead={deleteLead}
                        tasks={tasks}
                        teamMembers={TEAM_MEMBERS}
                    />
                    <AddLeadModal isOpen={showAdd} onClose={() => setShowAdd(false)} onAdd={addLead} />
                    <div className="toast-container">
                        <AnimatePresence>
                            {toasts.map(t => <Toast key={t.id} message={t.message} type={t.type} onClose={() => setToasts(p => p.filter(x => x.id !== t.id))} />)}
                        </AnimatePresence>
                    </div>
                    {loading && <div className="loading-overlay"><div className="loading-spinner"></div></div>}
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
