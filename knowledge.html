<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EasyChat - ×××’×¨ ××™×“×¢</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase Config (inline)
        const SUPABASE_URL = 'https://tqxrahpbidlctyttpffc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRxeHJhaHBiaWRsY3R5dHRwZmZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4NTk3MzQsImV4cCI6MjA4MzQzNTczNH0.tmh9_GzWJhIcRoS3L6gpCX95_eZrkIR7hy3gOl9Qd2s';
        let supabaseClient = null;
        
        function getSupabase() {
            if (!supabaseClient) {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            }
            return supabaseClient;
        }
        function getBusinessId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('business_id') || localStorage.getItem('business_id') || 'demo-business';
        }
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            if (!container) return;
            const bgColor = type === 'success' ? 'bg-emerald-500' : type === 'error' ? 'bg-red-500' : 'bg-amber-500';
            const toast = document.createElement('div');
            toast.className = `${bgColor} text-white px-6 py-3 rounded-xl shadow-lg`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        
        const CATEGORY_LABELS = {
            pricing: 'ğŸ’° ××—×™×¨×™×',
            services: 'ğŸ› ï¸ ×©×™×¨×•×ª×™×',
            hours: 'ğŸ• ×©×¢×•×ª ×¤×¢×™×œ×•×ª',
            location: 'ğŸ“ ××™×§×•×',
            terms: 'ğŸ“‹ ×ª× ××™×',
            faq: 'â“ ×©××œ×•×ª × ×¤×•×¦×•×ª',
            other: 'ğŸ“ ××—×¨'
        };
        
        async function autoCategorizeBusiness(text) {
            const items = [];
            const lines = text.split('\n').filter(l => l.trim());
            let currentCategory = 'other';
            let currentQuestion = '';
            let currentAnswer = '';
            
            const categoryKeywords = {
                pricing: ['××—×™×¨', '×¢×œ×•×ª', '×ª×¢×¨×™×£', '×›××” ×¢×•×œ×”', 'â‚ª', '×©×§×œ'],
                hours: ['×©×¢×•×ª', '×¤×ª×•×—', '×¡×’×•×¨', '×™××™×', '×¤×¢×™×œ×•×ª'],
                location: ['××™×§×•×', '×›×ª×•×‘×ª', '××™×¤×”', '××¨×™× ×”', '×¨×—×•×‘'],
                services: ['×©×™×¨×•×ª', '××¦×™×¢×™×', '×›×•×œ×œ', '××¤×©×¨×•×™×•×ª'],
                terms: ['×ª× ××™×', '×‘×™×˜×•×œ', '×”×—×–×¨', '××“×™× ×™×•×ª']
            };
            
            for (const line of lines) {
                const lowerLine = line.toLowerCase();
                let foundCategory = null;
                for (const [cat, keywords] of Object.entries(categoryKeywords)) {
                    if (keywords.some(k => lowerLine.includes(k))) {
                        foundCategory = cat;
                        break;
                    }
                }
                
                if (foundCategory && line.endsWith(':')) {
                    if (currentQuestion && currentAnswer) {
                        items.push({ category: currentCategory, question: currentQuestion, answer: currentAnswer.trim(), keywords: [], is_active: true, priority: 5 });
                    }
                    currentCategory = foundCategory;
                    currentQuestion = '';
                    currentAnswer = '';
                } else if (line.includes('-') || line.includes(':')) {
                    if (currentQuestion && currentAnswer) {
                        items.push({ category: currentCategory, question: currentQuestion, answer: currentAnswer.trim(), keywords: [], is_active: true, priority: 5 });
                    }
                    const parts = line.split(/[-:]/).map(p => p.trim());
                    if (parts.length >= 2) {
                        currentQuestion = parts[0] + '?';
                        currentAnswer = parts.slice(1).join(' ');
                    }
                } else if (currentQuestion) {
                    currentAnswer += ' ' + line;
                }
            }
            
            if (currentQuestion && currentAnswer) {
                items.push({ category: currentCategory, question: currentQuestion, answer: currentAnswer.trim(), keywords: [], is_active: true, priority: 5 });
            }
            
            return items;
        }
    </script>
    <script>
        tailwind.config = {
            theme: { extend: { colors: { primary: '#6366f1', 'primary-dark': '#4f46e5', secondary: '#8b5cf6', dark: '#0f172a', success: '#10b981', warning: '#f59e0b', danger: '#ef4444' } } }
        }
    </script>
    <style>
        * { font-family: 'Heebo', sans-serif; }
        body { background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%); min-height: 100vh; }
        .glass { background: rgba(255,255,255,0.03); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.08); }
        .gradient-primary { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); }
        .gradient-glow { box-shadow: 0 0 40px rgba(99, 102, 241, 0.3); }
        .card-modern { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06); border-radius: 24px; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .card-modern:hover { background: rgba(255,255,255,0.05); border-color: rgba(99, 102, 241, 0.3); transform: translateY(-4px); box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
        .sidebar-modern { background: linear-gradient(180deg, rgba(15,23,42,0.98) 0%, rgba(30,41,59,0.98) 100%); border-left: 1px solid rgba(255,255,255,0.06); }
        .sidebar-item { transition: all 0.3s ease; border-radius: 16px; }
        .sidebar-item:hover { background: rgba(99, 102, 241, 0.1); }
        .sidebar-item.active { background: linear-gradient(135deg, rgba(99, 102, 241, 0.2) 0%, rgba(139, 92, 246, 0.2) 100%); border: 1px solid rgba(99, 102, 241, 0.3); }
        .btn-modern { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); border-radius: 16px; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4); }
        .btn-modern:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(99, 102, 241, 0.5); }
        .btn-outline { background: transparent; border: 2px solid rgba(99, 102, 241, 0.5); border-radius: 16px; color: #a5b4fc; transition: all 0.3s ease; }
        .btn-outline:hover { background: rgba(99, 102, 241, 0.1); border-color: #6366f1; }
        .input-modern { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; color: white; transition: all 0.3s ease; }
        .input-modern:focus { background: rgba(255,255,255,0.08); border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); outline: none; }
        .input-modern::placeholder { color: rgba(255,255,255,0.4); }
        .input-modern option { background: #1e293b; color: white; }
        .badge { padding: 6px 14px; border-radius: 30px; font-size: 12px; font-weight: 600; }
        .badge-pricing { background: rgba(16, 185, 129, 0.15); color: #34d399; }
        .badge-services { background: rgba(99, 102, 241, 0.15); color: #a5b4fc; }
        .badge-hours { background: rgba(245, 158, 11, 0.15); color: #fbbf24; }
        .badge-location { background: rgba(236, 72, 153, 0.15); color: #f472b6; }
        .badge-terms { background: rgba(239, 68, 68, 0.15); color: #f87171; }
        .badge-faq { background: rgba(6, 182, 212, 0.15); color: #22d3ee; }
        .badge-other { background: rgba(148, 163, 184, 0.15); color: #cbd5e1; }
        .modal-overlay { background: rgba(0,0,0,0.8); backdrop-filter: blur(12px); }
        .modal-content { animation: modalIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .modal-dark { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border: 1px solid rgba(255,255,255,0.1); }
        @keyframes modalIn { from { opacity: 0; transform: scale(0.9) translateY(40px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .stat-card { background: linear-gradient(135deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0.01) 100%); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(255,255,255,0.02); }
        ::-webkit-scrollbar-thumb { background: rgba(99, 102, 241, 0.3); border-radius: 3px; }
        .toggle-modern { position: relative; width: 56px; height: 28px; background: rgba(255,255,255,0.1); border-radius: 14px; cursor: pointer; transition: all 0.3s ease; }
        .toggle-modern.active { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .toggle-modern::after { content: ''; position: absolute; top: 3px; left: 3px; width: 22px; height: 22px; background: white; border-radius: 50%; transition: transform 0.3s ease; }
        .toggle-modern.active::after { transform: translateX(28px); }
        select.input-modern { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%239ca3af' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: left 16px center; background-size: 16px; padding-left: 48px; }
        .setup-notice { background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(245, 158, 11, 0.05) 100%); border: 1px solid rgba(245, 158, 11, 0.3); }
    </style>
</head>
<body>
    <div id="toast-container" class="fixed top-4 left-4 z-50 flex flex-col gap-2"></div>
    
    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <aside class="sidebar-modern w-72 fixed h-full z-40">
            <div class="p-6 border-b border-white/5">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 gradient-primary rounded-2xl flex items-center justify-center gradient-glow">
                        <i data-lucide="message-square" class="w-6 h-6 text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-white">EasyChat</h1>
                        <p class="text-xs text-gray-400">× ×™×”×•×œ ×‘×•×˜ ×—×›×</p>
                    </div>
                </div>
            </div>
            
            <nav class="p-4 space-y-2">
                <a href="index.html" class="sidebar-item flex items-center gap-4 px-5 py-4 text-gray-300 hover:text-white">
                    <i data-lucide="message-circle" class="w-5 h-5"></i>
                    <span class="font-medium">×©×™×—×•×ª</span>
                </a>
                <a href="knowledge.html" class="sidebar-item active flex items-center gap-4 px-5 py-4 text-white">
                    <i data-lucide="brain" class="w-5 h-5"></i>
                    <span class="font-medium">×××’×¨ ××™×“×¢</span>
                </a>
                <a href="settings.html" class="sidebar-item flex items-center gap-4 px-5 py-4 text-gray-300 hover:text-white">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                    <span class="font-medium">×”×’×“×¨×•×ª</span>
                </a>
            </nav>
            
            <div class="absolute bottom-0 w-full p-4 border-t border-white/5">
                <div class="glass rounded-2xl p-4">
                    <div class="flex items-center gap-3">
                        <div class="w-3 h-3 bg-amber-500 rounded-full"></div>
                        <div>
                            <p class="text-sm font-medium text-white">××¦×‘ ×“××•</p>
                            <p class="text-xs text-gray-400">×¦×¨×™×š ×œ×”×’×“×™×¨ ×¢×¡×§</p>
                        </div>
                    </div>
                </div>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="flex-1 mr-72 p-8">
            <!-- Header -->
            <header class="flex items-center justify-between mb-8">
                <div>
                    <h2 class="text-3xl font-bold text-white mb-2">×××’×¨ ××™×“×¢ ğŸ§ </h2>
                    <p class="text-gray-400">×œ××“ ××ª ×”×‘×•×˜ ×œ×¢× ×•×ª ×¢×œ ×©××œ×•×ª ×”×œ×§×•×—×•×ª ×©×œ×š</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="openBulkModal()" class="btn-outline px-6 py-3 flex items-center gap-2">
                        <i data-lucide="wand-2" class="w-5 h-5"></i>
                        ×™×™×‘×•× ××”×™×¨
                    </button>
                    <button onclick="openModal()" class="btn-modern text-white px-6 py-3 flex items-center gap-2">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                        ×”×•×¡×£ ×©××œ×”
                    </button>
                </div>
            </header>
            
            <!-- Setup Notice -->
            <div id="setup-notice" class="setup-notice rounded-2xl p-6 mb-8 hidden">
                <div class="flex items-start gap-4">
                    <div class="w-12 h-12 rounded-xl bg-amber-500/20 flex items-center justify-center flex-shrink-0">
                        <i data-lucide="alert-triangle" class="w-6 h-6 text-amber-400"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-amber-400 mb-2">× ×“×¨×©×ª ×”×’×“×¨×” ×¨××©×•× ×™×ª</h3>
                        <p class="text-gray-300">×˜×‘×œ×ª knowledge_base ×¢×“×™×™×Ÿ ×œ× ×”×•×’×“×¨×” ×‘××¢×¨×›×ª. ×¦×•×¨ ××ª ×”×˜×‘×œ×” ×‘-Supabase ×›×“×™ ×œ×”×ª×—×™×œ ×œ×”×•×¡×™×£ ×©××œ×•×ª.</p>
                    </div>
                </div>
            </div>
            
            <!-- Stats -->
            <section class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <div class="stat-card card-modern p-5 flex items-center gap-4">
                    <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-indigo-500/20 to-purple-500/20 flex items-center justify-center">
                        <i data-lucide="database" class="w-7 h-7 text-indigo-400"></i>
                    </div>
                    <div>
                        <p class="text-3xl font-bold text-white" id="total-questions">0</p>
                        <p class="text-sm text-gray-400">×¡×”"×› ×©××œ×•×ª</p>
                    </div>
                </div>
                <div class="stat-card card-modern p-5 flex items-center gap-4">
                    <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-emerald-500/20 to-teal-500/20 flex items-center justify-center">
                        <i data-lucide="check-circle-2" class="w-7 h-7 text-emerald-400"></i>
                    </div>
                    <div>
                        <p class="text-3xl font-bold text-white" id="active-questions">0</p>
                        <p class="text-sm text-gray-400">×¤×¢×™×œ×™×</p>
                    </div>
                </div>
                <div class="stat-card card-modern p-5 flex items-center gap-4">
                    <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-amber-500/20 to-orange-500/20 flex items-center justify-center">
                        <i data-lucide="layers" class="w-7 h-7 text-amber-400"></i>
                    </div>
                    <div>
                        <p class="text-3xl font-bold text-white" id="total-categories">0</p>
                        <p class="text-sm text-gray-400">×§×˜×’×•×¨×™×•×ª</p>
                    </div>
                </div>
                <div class="stat-card card-modern p-5 flex items-center gap-4">
                    <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-pink-500/20 to-rose-500/20 flex items-center justify-center">
                        <i data-lucide="sparkles" class="w-7 h-7 text-pink-400"></i>
                    </div>
                    <div>
                        <p class="text-3xl font-bold text-white" id="ai-coverage">0%</p>
                        <p class="text-sm text-gray-400">×›×™×¡×•×™ AI</p>
                    </div>
                </div>
            </section>
            
            <!-- Filters -->
            <section class="glass rounded-3xl p-5 mb-8">
                <div class="flex flex-wrap items-center gap-4">
                    <div class="flex-1 min-w-64 relative">
                        <i data-lucide="search" class="w-5 h-5 text-gray-400 absolute right-4 top-1/2 -translate-y-1/2"></i>
                        <input type="text" id="search-input" placeholder="×—×¤×© ×©××œ×” ××• ×ª×©×•×‘×”..." class="input-modern w-full pr-12 pl-4 py-4">
                    </div>
                    <select id="category-filter" class="input-modern px-5 py-4 min-w-44">
                        <option value="">×›×œ ×”×§×˜×’×•×¨×™×•×ª</option>
                        <option value="pricing">ğŸ’° ××—×™×¨×™×</option>
                        <option value="services">ğŸ› ï¸ ×©×™×¨×•×ª×™×</option>
                        <option value="hours">ğŸ• ×©×¢×•×ª ×¤×¢×™×œ×•×ª</option>
                        <option value="location">ğŸ“ ××™×§×•×</option>
                        <option value="terms">ğŸ“‹ ×ª× ××™×</option>
                        <option value="faq">â“ ×©××œ×•×ª × ×¤×•×¦×•×ª</option>
                        <option value="other">ğŸ“ ××—×¨</option>
                    </select>
                    <select id="status-filter" class="input-modern px-5 py-4 min-w-36">
                        <option value="">×”×›×œ</option>
                        <option value="active">âœ… ×¤×¢×™×œ×™×</option>
                        <option value="inactive">âŒ ××•×©×‘×ª×™×</option>
                    </select>
                </div>
            </section>
            
            <!-- Knowledge Grid -->
            <section class="grid grid-cols-1 lg:grid-cols-2 gap-5" id="knowledge-grid"></section>
            
            <!-- Empty State -->
            <div class="text-center py-20" id="empty-state">
                <div class="w-32 h-32 mx-auto mb-8 rounded-full bg-gradient-to-br from-indigo-500/10 to-purple-500/10 flex items-center justify-center">
                    <i data-lucide="brain" class="w-16 h-16 text-indigo-400"></i>
                </div>
                <h3 class="text-2xl font-bold text-white mb-3">×”×‘×•×˜ ×©×œ×š ×¢×“×™×™×Ÿ ×œ× ×™×•×“×¢ ×›×œ×•×</h3>
                <p class="text-gray-400 mb-8 max-w-md mx-auto">×”×•×¡×£ ×©××œ×•×ª ×•×ª×©×•×‘×•×ª ×›×“×™ ×©×”×‘×•×˜ ×™×•×›×œ ×œ×¢× ×•×ª ×œ×œ×§×•×—×•×ª ×©×œ×š</p>
                <div class="flex gap-4 justify-center">
                    <button onclick="openBulkModal()" class="btn-outline px-8 py-4 flex items-center gap-2">
                        <i data-lucide="wand-2" class="w-5 h-5"></i>
                        ×™×™×‘×•× ××”×™×¨
                    </button>
                    <button onclick="openModal()" class="btn-modern text-white px-8 py-4 flex items-center gap-2">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                        ×”×•×¡×£ ×©××œ×” ×¨××©×•× ×”
                    </button>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Add/Edit Modal -->
    <div id="modal" class="fixed inset-0 z-50 hidden">
        <div class="modal-overlay absolute inset-0" onclick="closeModal()"></div>
        <div class="modal-content modal-dark absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-2xl rounded-3xl shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between p-6 border-b border-white/10">
                <h3 class="text-xl font-bold text-white" id="modal-title">×”×•×¡×£ ×©××œ×” ×—×“×©×”</h3>
                <button onclick="closeModal()" class="p-2 hover:bg-white/10 rounded-xl"><i data-lucide="x" class="w-5 h-5 text-gray-400"></i></button>
            </div>
            <form id="knowledge-form" class="p-6 space-y-5">
                <input type="hidden" id="edit-id">
                <div>
                    <label class="block text-sm font-semibold text-gray-300 mb-2">×§×˜×’×•×¨×™×” *</label>
                    <select id="form-category" required class="input-modern w-full px-5 py-4">
                        <option value="">×‘×—×¨ ×§×˜×’×•×¨×™×”</option>
                        <option value="pricing">ğŸ’° ××—×™×¨×™×</option>
                        <option value="services">ğŸ› ï¸ ×©×™×¨×•×ª×™×</option>
                        <option value="hours">ğŸ• ×©×¢×•×ª ×¤×¢×™×œ×•×ª</option>
                        <option value="location">ğŸ“ ××™×§×•×</option>
                        <option value="terms">ğŸ“‹ ×ª× ××™×</option>
                        <option value="faq">â“ ×©××œ×•×ª × ×¤×•×¦×•×ª</option>
                        <option value="other">ğŸ“ ××—×¨</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-300 mb-2">×”×©××œ×” *</label>
                    <input type="text" id="form-question" required placeholder='×œ×“×•×’××”: "×›××” ×¢×•×œ×”?"' class="input-modern w-full px-5 py-4">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-300 mb-2">×”×ª×©×•×‘×” *</label>
                    <textarea id="form-answer" required rows="5" placeholder="×›×ª×•×‘ ×ª×©×•×‘×” ××¤×•×¨×˜×ª..." class="input-modern w-full px-5 py-4 resize-none"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-300 mb-2">××™×œ×•×ª ××¤×ª×—</label>
                    <input type="text" id="form-keywords" placeholder="××—×™×¨, ×¢×œ×•×ª, ×›××” (×”×¤×¨×“ ×‘×¤×¡×™×§×™×)" class="input-modern w-full px-5 py-4">
                </div>
                <div class="flex items-center justify-between p-5 bg-white/5 rounded-2xl">
                    <div>
                        <p class="font-semibold text-white">×©××œ×” ×¤×¢×™×œ×”</p>
                        <p class="text-sm text-gray-400">×”×‘×•×˜ ×™×©×ª××© ×‘×©××œ×” ×”×–×•</p>
                    </div>
                    <div id="form-active" class="toggle-modern active" onclick="toggleActive()"></div>
                </div>
            </form>
            <div class="flex items-center justify-end gap-3 p-6 border-t border-white/10">
                <button onclick="closeModal()" class="px-6 py-3 text-gray-400 hover:bg-white/10 rounded-2xl font-medium">×‘×™×˜×•×œ</button>
                <button onclick="saveKnowledge()" class="btn-modern text-white px-8 py-3 flex items-center gap-2">
                    <i data-lucide="save" class="w-4 h-4"></i>
                    <span id="save-btn-text">×©××•×¨</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Bulk Import Modal -->
    <div id="bulk-modal" class="fixed inset-0 z-50 hidden">
        <div class="modal-overlay absolute inset-0" onclick="closeBulkModal()"></div>
        <div class="modal-content modal-dark absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-3xl rounded-3xl shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between p-6 border-b border-white/10">
                <div>
                    <h3 class="text-xl font-bold text-white">×™×™×‘×•× ××”×™×¨ âœ¨</h3>
                    <p class="text-sm text-gray-400 mt-1">×”×“×‘×§ ×˜×§×¡×˜ ×¢× ××™×“×¢ ×¢×œ ×”×¢×¡×§</p>
                </div>
                <button onclick="closeBulkModal()" class="p-2 hover:bg-white/10 rounded-xl"><i data-lucide="x" class="w-5 h-5 text-gray-400"></i></button>
            </div>
            <div class="p-6 space-y-5">
                <div>
                    <label class="block text-sm font-semibold text-gray-300 mb-2">×”×“×‘×§ ××ª ×›×œ ×”××™×“×¢ ×¢×œ ×”×¢×¡×§</label>
                    <textarea id="bulk-text" rows="10" placeholder="××—×™×¨×™×:&#10;×©×™×¨×•×ª × - 100 ×©×´×—&#10;×©×™×¨×•×ª ×‘ - 200 ×©×´×—" class="input-modern w-full px-5 py-4 resize-none"></textarea>
                </div>
                <div id="bulk-preview" class="hidden">
                    <label class="block text-sm font-semibold text-gray-300 mb-3">×ª×¦×•×’×” ××§×“×™××”</label>
                    <div id="bulk-preview-content" class="space-y-3 max-h-60 overflow-y-auto"></div>
                </div>
            </div>
            <div class="flex items-center justify-end gap-3 p-6 border-t border-white/10">
                <button onclick="closeBulkModal()" class="px-6 py-3 text-gray-400 hover:bg-white/10 rounded-2xl font-medium">×‘×™×˜×•×œ</button>
                <button onclick="previewBulk()" id="preview-btn" class="btn-outline px-6 py-3 flex items-center gap-2">
                    <i data-lucide="eye" class="w-4 h-4"></i>
                    ×ª×¦×•×’×” ××§×“×™××”
                </button>
                <button onclick="importBulk()" id="import-btn" class="hidden btn-modern text-white px-8 py-3 flex items-center gap-2">
                    <i data-lucide="upload" class="w-4 h-4"></i>
                    ×™×™×‘× ×”×›×œ
                </button>
            </div>
        </div>
    </div>
    
    <!-- Delete Modal -->
    <div id="delete-modal" class="fixed inset-0 z-50 hidden">
        <div class="modal-overlay absolute inset-0" onclick="closeDeleteModal()"></div>
        <div class="modal-content modal-dark absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md rounded-3xl shadow-2xl p-8 text-center">
            <div class="w-20 h-20 mx-auto mb-6 bg-red-500/20 rounded-full flex items-center justify-center">
                <i data-lucide="trash-2" class="w-10 h-10 text-red-400"></i>
            </div>
            <h3 class="text-xl font-bold text-white mb-2">×œ××—×•×§ ××ª ×”×©××œ×”?</h3>
            <p class="text-gray-400 mb-8">×”×¤×¢×•×œ×” ×”×–×• ×œ× × ×™×ª× ×ª ×œ×‘×™×˜×•×œ</p>
            <div class="flex items-center justify-center gap-4">
                <button onclick="closeDeleteModal()" class="px-8 py-3 text-gray-400 hover:bg-white/10 rounded-2xl font-medium">×‘×™×˜×•×œ</button>
                <button onclick="confirmDelete()" class="bg-red-500 hover:bg-red-600 text-white px-8 py-3 rounded-2xl font-semibold">×›×Ÿ, ××—×§</button>
            </div>
        </div>
    </div>

<script>
const BUSINESS_ID = getBusinessId();
let knowledgeItems = [];
let deleteItemId = null;
let isEditMode = false;
let bulkItems = [];
let tableExists = true;

lucide.createIcons();

async function loadKnowledge() {
    try {
        const db = getSupabase();
        const { data, error } = await db.from('knowledge_base').select('*').eq('business_id', BUSINESS_ID).order('priority', { ascending: false });
        
        if (error) {
            console.log('Table error:', error);
            tableExists = false;
            document.getElementById('setup-notice').classList.remove('hidden');
            document.getElementById('empty-state').classList.add('hidden');
            return;
        }
        
        knowledgeItems = data || [];
        renderKnowledge();
        updateStats();
    } catch (error) {
        console.error('Error:', error);
        tableExists = false;
        document.getElementById('setup-notice').classList.remove('hidden');
    }
}

function renderKnowledge(items = knowledgeItems) {
    const grid = document.getElementById('knowledge-grid');
    const emptyState = document.getElementById('empty-state');
    grid.innerHTML = '';
    
    if (items.length === 0) {
        emptyState.classList.remove('hidden');
        return;
    }
    emptyState.classList.add('hidden');
    
    items.forEach((item, index) => {
        const card = document.createElement('div');
        card.className = `card-modern p-6 ${!item.is_active ? 'opacity-50' : ''}`;
        
        const categoryLabel = CATEGORY_LABELS[item.category] || item.category;
        
        card.innerHTML = `
            <div class="flex items-start justify-between mb-4">
                <span class="badge badge-${item.category}">${categoryLabel}</span>
                <div class="flex items-center gap-2">
                    ${!item.is_active ? '<span class="text-xs text-gray-400 bg-white/10 px-3 py-1 rounded-full">××•×©×‘×ª</span>' : ''}
                    <div class="relative">
                        <button onclick="toggleMenu('${item.id}')" class="p-2 hover:bg-white/10 rounded-xl">
                            <i data-lucide="more-vertical" class="w-4 h-4 text-gray-400"></i>
                        </button>
                        <div id="menu-${item.id}" class="hidden absolute left-0 top-full mt-2 modal-dark rounded-2xl shadow-xl py-2 min-w-36 z-10">
                            <button onclick="editItem('${item.id}')" class="w-full px-4 py-3 text-right text-sm hover:bg-white/10 flex items-center gap-3 text-gray-300">
                                <i data-lucide="edit-2" class="w-4 h-4"></i> ×¢×¨×•×š
                            </button>
                            <button onclick="toggleItemActive('${item.id}')" class="w-full px-4 py-3 text-right text-sm hover:bg-white/10 flex items-center gap-3 text-gray-300">
                                <i data-lucide="${item.is_active ? 'eye-off' : 'eye'}" class="w-4 h-4"></i> ${item.is_active ? '×”×©×‘×ª' : '×”×¤×¢×œ'}
                            </button>
                            <button onclick="deleteItem('${item.id}')" class="w-full px-4 py-3 text-right text-sm hover:bg-red-500/20 flex items-center gap-3 text-red-400">
                                <i data-lucide="trash-2" class="w-4 h-4"></i> ××—×§
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <h4 class="font-bold text-white text-lg mb-3">${item.question}</h4>
            <p class="text-gray-400 text-sm whitespace-pre-line line-clamp-3">${item.answer}</p>
        `;
        
        grid.appendChild(card);
    });
    
    lucide.createIcons();
}

function updateStats() {
    const total = knowledgeItems.length;
    const active = knowledgeItems.filter(i => i.is_active).length;
    const categories = [...new Set(knowledgeItems.map(i => i.category))].length;
    const coverage = total > 0 ? Math.round((active / total) * 100) : 0;
    
    document.getElementById('total-questions').textContent = total;
    document.getElementById('active-questions').textContent = active;
    document.getElementById('total-categories').textContent = categories;
    document.getElementById('ai-coverage').textContent = coverage + '%';
}

function toggleMenu(id) {
    document.querySelectorAll('[id^="menu-"]').forEach(m => {
        if (m.id !== `menu-${id}`) m.classList.add('hidden');
    });
    document.getElementById(`menu-${id}`).classList.toggle('hidden');
}

document.addEventListener('click', (e) => {
    if (!e.target.closest('[id^="menu-"]') && !e.target.closest('button')) {
        document.querySelectorAll('[id^="menu-"]').forEach(m => m.classList.add('hidden'));
    }
});

function editItem(id) {
    const item = knowledgeItems.find(i => i.id === id);
    if (!item) return;
    
    isEditMode = true;
    document.getElementById('edit-id').value = id;
    document.getElementById('modal-title').textContent = '×¢×¨×•×š ×©××œ×”';
    document.getElementById('save-btn-text').textContent = '×¢×“×›×Ÿ';
    document.getElementById('form-category').value = item.category;
    document.getElementById('form-question').value = item.question;
    document.getElementById('form-answer').value = item.answer;
    document.getElementById('form-keywords').value = (item.keywords || []).join(', ');
    document.getElementById('form-active').classList.toggle('active', item.is_active);
    
    openModal();
}

async function toggleItemActive(id) {
    const item = knowledgeItems.find(i => i.id === id);
    if (!item) return;
    
    try {
        const db = getSupabase();
        await db.from('knowledge_base').update({ is_active: !item.is_active }).eq('id', id);
        item.is_active = !item.is_active;
        renderKnowledge();
        updateStats();
        showToast(item.is_active ? '×”×©××œ×” ×”×•×¤×¢×œ×”' : '×”×©××œ×” ×”×•×©×‘×ª×”');
    } catch (error) {
        showToast('×©×’×™××” ×‘×¢×“×›×•×Ÿ', 'error');
    }
}

function deleteItem(id) {
    deleteItemId = id;
    document.getElementById('delete-modal').classList.remove('hidden');
}

async function confirmDelete() {
    if (!deleteItemId) return;
    try {
        const db = getSupabase();
        await db.from('knowledge_base').delete().eq('id', deleteItemId);
        knowledgeItems = knowledgeItems.filter(i => i.id !== deleteItemId);
        renderKnowledge();
        updateStats();
        closeDeleteModal();
        showToast('×”×©××œ×” × ××—×§×”');
    } catch (error) {
        showToast('×©×’×™××” ×‘××—×™×§×”', 'error');
    }
}

function closeDeleteModal() {
    document.getElementById('delete-modal').classList.add('hidden');
    deleteItemId = null;
}

function openModal() {
    document.getElementById('modal').classList.remove('hidden');
    lucide.createIcons();
}

function closeModal() {
    document.getElementById('modal').classList.add('hidden');
    resetForm();
}

function resetForm() {
    isEditMode = false;
    document.getElementById('edit-id').value = '';
    document.getElementById('modal-title').textContent = '×”×•×¡×£ ×©××œ×” ×—×“×©×”';
    document.getElementById('save-btn-text').textContent = '×©××•×¨';
    document.getElementById('knowledge-form').reset();
    document.getElementById('form-active').classList.add('active');
}

function toggleActive() {
    document.getElementById('form-active').classList.toggle('active');
}

async function saveKnowledge() {
    if (!tableExists) {
        showToast('×˜×‘×œ×ª knowledge_base ×œ× ×§×™×™××ª. ×¦×•×¨ ××•×ª×” ×‘-Supabase.', 'error');
        return;
    }
    
    const category = document.getElementById('form-category').value;
    const question = document.getElementById('form-question').value.trim();
    const answer = document.getElementById('form-answer').value.trim();
    const keywordsStr = document.getElementById('form-keywords').value.trim();
    const isActive = document.getElementById('form-active').classList.contains('active');
    
    if (!category || !question || !answer) {
        showToast('× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª ×”× ×“×¨×©×™×', 'error');
        return;
    }
    
    const keywords = keywordsStr ? keywordsStr.split(',').map(k => k.trim()).filter(k => k) : [];
    const data = { category, question, answer, keywords, is_active: isActive, priority: 5 };
    
    try {
        const db = getSupabase();
        
        if (isEditMode) {
            const id = document.getElementById('edit-id').value;
            await db.from('knowledge_base').update(data).eq('id', id);
            const idx = knowledgeItems.findIndex(i => i.id === id);
            if (idx !== -1) knowledgeItems[idx] = { ...knowledgeItems[idx], ...data };
            showToast('×”×©××œ×” ×¢×•×“×›× ×” ×‘×”×¦×œ×—×”!');
        } else {
            const { data: newItem, error } = await db.from('knowledge_base').insert({ ...data, business_id: BUSINESS_ID }).select().single();
            if (error) throw error;
            knowledgeItems.unshift(newItem);
            showToast('×”×©××œ×” × ×•×¡×¤×” ×‘×”×¦×œ×—×”!');
        }
        
        renderKnowledge();
        updateStats();
        closeModal();
    } catch (error) {
        console.error(error);
        showToast('×©×’×™××” ×‘×©××™×¨×”', 'error');
    }
}

function openBulkModal() {
    document.getElementById('bulk-modal').classList.remove('hidden');
    lucide.createIcons();
}

function closeBulkModal() {
    document.getElementById('bulk-modal').classList.add('hidden');
    document.getElementById('bulk-text').value = '';
    document.getElementById('bulk-preview').classList.add('hidden');
    document.getElementById('preview-btn').classList.remove('hidden');
    document.getElementById('import-btn').classList.add('hidden');
    bulkItems = [];
}

async function previewBulk() {
    const text = document.getElementById('bulk-text').value.trim();
    if (!text) {
        showToast('× × ×œ×”×–×™×Ÿ ×˜×§×¡×˜', 'warning');
        return;
    }
    
    bulkItems = await autoCategorizeBusiness(text);
    
    if (bulkItems.length === 0) {
        showToast('×œ× × ××¦× ××™×“×¢ ×œ×™×™×‘×', 'warning');
        return;
    }
    
    const previewContent = document.getElementById('bulk-preview-content');
    previewContent.innerHTML = bulkItems.map(item => `
        <div class="flex items-start gap-3 p-4 bg-white/5 rounded-xl">
            <span class="badge badge-${item.category} text-xs">${CATEGORY_LABELS[item.category] || item.category}</span>
            <div class="flex-1">
                <p class="font-medium text-white text-sm">${item.question}</p>
                <p class="text-gray-400 text-xs mt-1">${item.answer}</p>
            </div>
        </div>
    `).join('');
    
    document.getElementById('bulk-preview').classList.remove('hidden');
    document.getElementById('preview-btn').classList.add('hidden');
    document.getElementById('import-btn').classList.remove('hidden');
    
    showToast(`× ××¦××• ${bulkItems.length} ×¤×¨×™×˜×™× ×œ×™×™×‘×•×`);
}

async function importBulk() {
    if (!tableExists) {
        showToast('×˜×‘×œ×ª knowledge_base ×œ× ×§×™×™××ª', 'error');
        return;
    }
    if (bulkItems.length === 0) return;
    
    try {
        const db = getSupabase();
        const itemsToInsert = bulkItems.map(item => ({ ...item, business_id: BUSINESS_ID }));
        
        const { data, error } = await db.from('knowledge_base').insert(itemsToInsert).select();
        if (error) throw error;
        
        knowledgeItems = [...data, ...knowledgeItems];
        renderKnowledge();
        updateStats();
        closeBulkModal();
        showToast(`×™×•×‘××• ${data.length} ×©××œ×•×ª ×‘×”×¦×œ×—×”!`);
    } catch (error) {
        console.error(error);
        showToast('×©×’×™××” ×‘×™×™×‘×•×', 'error');
    }
}

document.getElementById('search-input').addEventListener('input', filterKnowledge);
document.getElementById('category-filter').addEventListener('change', filterKnowledge);
document.getElementById('status-filter').addEventListener('change', filterKnowledge);

function filterKnowledge() {
    const search = document.getElementById('search-input').value.toLowerCase();
    const category = document.getElementById('category-filter').value;
    const status = document.getElementById('status-filter').value;
    
    let filtered = knowledgeItems;
    
    if (search) {
        filtered = filtered.filter(i => 
            i.question.toLowerCase().includes(search) || 
            i.answer.toLowerCase().includes(search)
        );
    }
    if (category) filtered = filtered.filter(i => i.category === category);
    if (status === 'active') filtered = filtered.filter(i => i.is_active);
    else if (status === 'inactive') filtered = filtered.filter(i => !i.is_active);
    
    renderKnowledge(filtered);
}

document.addEventListener('DOMContentLoaded', loadKnowledge);
</script>
</body>
</html>
